<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>آینه آینده X — نسخه نهایی جامع</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg1:#0b111a; --bg2:#0e1624; --panel:#0f1726; --chip:#0b1322;
    --text:#eaf1ff; --muted:#9fb0cc; --border:#22304a; --accent:#7ee787; --accent2:#7aa2f7;
    --warn:#ffcd4d; --risk:#ff6b6b; --ok:#00d2a8;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:15px/1.8 Vazirmatn,Segoe UI,Roboto,Arial;background:
    radial-gradient(1200px 800px at 80% -10%,#1a2642 0%,rgba(11,18,32,0) 70%),linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text)}
  a{color:inherit}
  header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:linear-gradient(180deg,rgba(11,18,32,.92),rgba(11,18,32,.6) 70%,transparent);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:36px;height:36px;border-radius:10px;background:
    radial-gradient(80% 80% at 30% 30%, #7ee78744, transparent 70%),linear-gradient(135deg,#24344a,#141c29);
    border:1px solid var(--border);box-shadow:0 0 28px #7ee78722 inset,0 0 12px #7aa2f722}
  h1{margin:0;font-size:18px}
  .sub{font-size:12px;color:var(--muted)}
  .header-actions{display:flex;gap:8px;align-items:center}
  .btn{background:linear-gradient(180deg,#1e2f4a,#17243a);border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#1a3b34,#112822);border-color:#2a7b5f;color:#aef7d3}
  .btn:hover{transform:translateY(-1px)}
  .toggle{display:inline-flex;align-items:center;gap:6px;font-size:13px}
  .toggle input{accent-color:var(--accent);width:18px;height:18px}
  .container{max-width:1240px;margin:16px auto 60px;padding:0 16px}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:14px}
  @media (max-width:1020px){.grid{grid-template-columns:1fr}}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:16px;padding:12px 14px;box-shadow:0 8px 30px rgba(0,0,0,.25),inset 0 1px 0 rgba(255,255,255,.06)}
  .panel h2{font-size:16px;margin:0 0 8px 0;color:#cfe3ff}
  .panel p{color:var(--muted);margin:6px 0 10px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 160px}
  .input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0e1420;color:var(--text);outline:none}
  label{display:block;font-size:13px;color:#cfe3ff;margin:8px 0 6px}
  .hint{font-size:12px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--border);background:var(--chip);color:#cfe3ff;font-size:12px;padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
  .chip .dot{width:7px;height:7px;border-radius:999px;background:var(--accent);box-shadow:0 0 10px var(--accent)}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kcard{flex:1 1 160px;background:#0b1322;border:1px solid var(--border);border-radius:14px;padding:10px}
  .kcard .t{font-size:12px;color:#b7c7e8}
  .progress{height:10px;background:#0f1a2b;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .progress > span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#42b883);width:0%}
  .progress.neutral > span{background:linear-gradient(90deg,#7aa2f7,#c7d2fe)}
  .progress.risk > span{background:linear-gradient(90deg,#ff6b6b,#ff9f7a)}
  .alerts{display:flex;flex-direction:column;gap:8px}
  .alert{border:1px solid var(--border);border-left:4px solid var(--warn);background:rgba(255,205,77,.08);padding:8px 10px;border-radius:12px}
  .alert.danger{border-left-color:var(--risk);background:rgba(255,107,107,.08)}
  .alert.ok{border-left-color:var(--ok);background:rgba(0,210,168,.08)}
  .viz{display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
  @media (max-width:1020px){.viz{grid-template-columns:1fr}}
  .canvasWrap{position:relative;background:linear-gradient(180deg,rgba(15,21,32,.8),rgba(10,14,22,.6));border:1px solid var(--border);border-radius:14px;padding:8px}
  #radar{width:100%;height:360px}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .legend .chip{background:#0e1726}
  .why{background:linear-gradient(180deg,#0e1522,#0c111b);border:1px solid var(--border);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:8px;max-height:400px;overflow:auto}
  .why h3{margin:0 0 2px 0;font-size:14px;color:#cfe3ff}
  .reason{display:flex;gap:10px;border-bottom:1px dashed var(--border);padding-bottom:8px}
  .reason:last-child{border-bottom:none}
  .bar{height:6px;background:#122036;border-radius:8px;overflow:hidden}
  .bar > span{display:block;height:100%;background:linear-gradient(90deg,#7ee787,#7aa2f7)}
  .srcs{display:flex;flex-wrap:wrap;gap:8px}
  .timeline{background:linear-gradient(180deg,#0e1522,#0c111b);border:1px solid var(--border);border-radius:14px;padding:10px}
  .timeline svg{width:100%;height:140px}
  .tick text{fill:#a9bfde;font-size:12px}
  .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:900px){.actions{grid-template-columns:1fr}}
  .actionCard{background:linear-gradient(180deg,#0f1726,#0c131f);border:1px solid var(--border);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:6px}
  .pill{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:#bcd2f0;display:inline-flex;gap:6px;align-items:center}
  .impact{color:#aef7d3}.difficulty{color:#ffd28b}
  .matrix{margin-top:8px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .matrix table{width:100%;border-collapse:collapse;font-size:12px}
  .matrix th,.matrix td{padding:8px 10px;border-bottom:1px solid var(--border)}
  .matrix th{background:#0f1624;color:#cfe3ff;position:sticky;top:0}
  .analysisBox{background:linear-gradient(180deg,#0e1522,#0c111b);border:1px solid var(--border);border-radius:14px;padding:12px;line-height:1.9}
  .analysisBox .rec{margin-top:10px;padding:8px;border-left:3px solid var(--accent);background:rgba(126,231,135,.06);border-radius:8px}
  .analysisBox .reason{font-size:12px;color:var(--muted);margin-top:4px}
  /* Future Jobs */
  .jobs{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (max-width:900px){.jobs{grid-template-columns:1fr}}
  .job{background:linear-gradient(180deg,#0f1726,#0c131f);border:1px solid var(--border);border-radius:14px;padding:12px}
  .job h3{margin:0 0 6px 0}
  .badge{display:inline-flex;gap:6px;align-items:center;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:#cfe3ff;background:#0e1726}
  .gap{color:#ffd28b}
  .ok{color:#aef7d3}
  footer{margin:20px 0 50px;text-align:center;color:#89a1c5;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>آینه آینده X — نسخه نهایی جامع</h1>
      <div class="sub">سناریوساز شخصی + شغل‌های آینده مقاوم در برابر هوش مصنوعی</div>
    </div>
  </div>
  <div class="header-actions">
    <button id="saveBtn" class="btn" aria-label="ذخیره سناریو">ذخیره</button>
    <button id="exportBtn" class="btn" aria-label="چاپ و خروجی PDF">چاپ/PDF</button>
    <label class="toggle" for="themeToggle">
      <input id="themeToggle" type="checkbox" /> حالت روشن
    </label>
  </div>
</header>

<div class="container">
  <div class="grid" role="region" aria-label="پیکربندی و نتایج">
    <!-- Sidebar -->
    <div class="panel" aria-labelledby="profile-title">
      <h2 id="profile-title">پروفایل، تصمیم و منابع</h2>

      <label for="decision">عنوان تصمیم</label>
      <input id="decision" class="input" type="text" placeholder="مثلاً: تغییر مسیر به علم داده">

      <div class="row">
        <div class="col">
          <label for="risk">تحمل ریسک</label>
          <select id="risk">
            <option value="low">کم</option>
            <option value="mid" selected>متوسط</option>
            <option value="high">زیاد</option>
          </select>
        </div>
        <div class="col">
          <label for="horizon">افق زمانی</label>
          <select id="horizon">
            <option value="6">۶ ماه</option>
            <option value="12" selected>۱۲ ماه</option>
            <option value="24">۲۴ ماه</option>
            <option value="36">۳۶ ماه</option>
          </select>
        </div>
      </div>

      <label>ترندهای مدنظر</label>
      <div id="trendChips" class="chips" aria-label="انتخاب ترندها"></div>
      <div class="hint">روشن/خاموش کن تا اثر روی ریسک/فرصت/عدم‌قطعیت را ببینی.</div>

      <label for="profileText">مهارت‌ها/رزومه/لینک‌ها</label>
      <textarea id="profileText" class="input" placeholder="AI, Data, Python, انرژی پاک، لینک GitHub/LinkedIn..."></textarea>
      <div class="row">
        <button id="analyzeBtn" class="btn" aria-label="تحلیل مهارت‌ها">تحلیل مهارت</button>
        <div id="skillNote" class="hint" aria-live="polite">تحلیل محلی و سریع</div>
      </div>

      <h2 style="margin-top:10px">اندیشکده‌ها و وزن‌دهی دامنه‌ها</h2>
      <p class="hint">وزن‌ها بر اساس تصمیم/ترند تنظیم می‌شوند و به‌صورت توضیح‌پذیر در ماتریس نمایش داده می‌شوند.</p>
      <div class="matrix" style="margin-bottom:10px">
        <table id="matrixTable">
          <thead>
            <tr><th>دامنه</th><th>وزن پایه</th><th>وزن پویا</th><th>توضیح</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="chips" id="sourceChips" aria-label="اندیشکده‌های مؤثر"></div>

      <h2 style="margin-top:10px">آستانه هشدار</h2>
      <div class="row">
        <div class="col">
          <label for="thrRisk">آستانه ریسک سیستمی</label>
          <input id="thrRisk" class="input" type="number" min="0" max="1" step="0.01" value="0.6" />
        </div>
        <div class="col">
          <label for="thrUnc">آستانه عدم‌قطعیت</label>
          <input id="thrUnc" class="input" type="number" min="0" max="1" step="0.01" value="0.7" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="simulate" class="btn primary" aria-label="شبیه‌سازی">شبیه‌سازی</button>
        <span id="status" class="hint" aria-live="polite">آماده</span>
      </div>
    </div>

    <!-- Main -->
    <div class="panel" aria-labelledby="results-title">
      <h2 id="results-title">نتایج و تحلیل</h2>

      <div class="kpi" role="group" aria-label="شاخص‌های کلیدی">
        <div class="kcard">
          <div class="t">شاخص فرصت</div>
          <div id="oppVal" style="font-weight:700">—</div>
          <div class="progress"><span id="oppBar" style="width:0%"></span></div>
        </div>
        <div class="kcard">
          <div class="t">ریسک سیستمی</div>
          <div id="riskVal" style="font-weight:700">—</div>
          <div class="progress risk"><span id="riskBar" style="width:0%"></span></div>
        </div>
        <div class="kcard">
          <div class="t">عدم‌قطعیت</div>
          <div id="uncVal" style="font-weight:700">—</div>
          <div class="progress neutral"><span id="uncBar" style="width:0%"></span></div>
        </div>
        <div class="kcard">
          <div class="t">امکان‌پذیری (منابع/مهارت)</div>
          <div id="feasVal" style="font-weight:700">—</div>
          <div class="progress"><span id="feasBar" style="width:0%"></span></div>
        </div>
      </div>

      <div class="section alerts" style="margin-top:10px">
        <div id="alertsBox"></div>
      </div>

      <div class="viz section" aria-label="تصویرسازی‌ها">
        <div class="canvasWrap">
          <canvas id="radar" aria-label="نمودار راداری ابعاد"></canvas>
          <div class="legend">
            <span class="chip"><span class="dot"></span> امتیاز</span>
            <span class="chip"><span class="dot" style="background:#ffd28b"></span> باند عدم‌قطعیت</span>
          </div>
        </div>
        <div class="why" aria-label="دلیل نتایج">
          <h3>چرا این نتیجه؟</h3>
          <div id="whyList"></div>
          <div>
            <div class="hint" style="margin:4px 0 6px">منابع/اندیشکده‌های مؤثر:</div>
            <div class="srcs" id="whySources"></div>
          </div>
        </div>
      </div>

      <div class="timeline section" aria-label="نقشه زمان">
        <h2>نقشه زمان 2025–2032</h2>
        <svg id="timelineSvg" viewBox="0 0 900 140" preserveAspectRatio="xMidYMid meet"></svg>
      </div>

      <div class="section" aria-label="سناریوهای نامتقارن">
        <h2>سناریوهای نامتقارن</h2>
        <div id="scenarios" class="actions"></div>
      </div>

      <div class="section" aria-label="گام‌های پیشنهادی">
        <h2>گام‌های پیشنهادی 30/90/180 روزه</h2>
        <div id="actions" class="actions"></div>
      </div>

      <div class="section" aria-label="ماتریس منابع">
        <h2>ماتریس وزن‌دهی منابع</h2>
        <div class="matrix">
          <table id="sourceTable">
            <thead>
              <tr><th>اندیشکده</th><th>دامنه غالب</th><th>وزن نهایی</th><th>اثر بر تصمیم</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="section" aria-label="تحلیل آینده و پیشنهادها">
        <h2>تحلیل آینده و پیشنهادها</h2>
        <div id="futureAnalysis" class="analysisBox"></div>
      </div>

      <!-- NEW: Future-proof Jobs -->
      <div class="section" aria-label="شغل‌های آینده مقاوم در برابر هوش مصنوعی">
        <h2>شغل‌های آینده مقاوم در برابر هوش مصنوعی</h2>
        <div class="row">
          <div class="col">
            <label for="autoPressure">فشار اتوماسیون (سناریو)</label>
            <select id="autoPressure">
              <option value="base" selected>عادی</option>
              <option value="elevated">افزایش‌یافته</option>
              <option value="extreme">حداکثری</option>
            </select>
          </div>
          <div class="col">
            <label for="jobCount">تعداد پیشنهاد شغلی</label>
            <select id="jobCount">
              <option>5</option>
              <option selected>8</option>
              <option>12</option>
            </select>
          </div>
        </div>
        <p class="hint">برای هر شغل: امتیاز مقاومت در برابر اتوماسیون، انطباق با ترندها و مهارت‌ها، و مسیر مرحله‌ای رسیدن با زمان/هزینه تخمینی نمایش داده می‌شود.</p>
        <div id="jobsWrap" class="jobs"></div>
      </div>
    </div>
  </div>

  <footer>نسخه نهایی — آماده انتشار در GitHub Pages. برای سفارشی‌سازی داده شغل/مسیر، آرایه JOBS را ویرایش کن.</footer>
</div>

<script>
  // ---------- Data ----------
  const DOMAINS = [
    { id:'tech', label:'فناوری/داده' },
    { id:'econ', label:'اقتصاد/بازار' },
    { id:'geo',  label:'ژئو/امنیت' },
    { id:'clim', label:'اقلیم/پایداری' },
    { id:'soc',  label:'جامعه/کار' },
  ];

  const TRENDS = [
    { id:'ai',      name:'هوش مصنوعی مولد',       risk:0.2,  opp:0.35, unc:0.15, domain:'tech' },
    { id:'green',   name:'گذار سبز/کربن‌صفر',     risk:0.18, opp:0.28, unc:0.14, domain:'clim' },
    { id:'geo',     name:'ریسک ژئوپلیتیک',        risk:0.35, opp:-0.05,unc:0.22, domain:'geo'  },
    { id:'supply',  name:'زنجیره تأمین نو',       risk:0.22, opp:0.18, unc:0.12, domain:'econ' },
    { id:'aging',   name:'سالمندی جمعیت',         risk:0.25, opp:0.05, unc:0.10, domain:'soc'  },
    { id:'bio',     name:'بیو/دیجیتال',           risk:0.15, opp:0.22, unc:0.12, domain:'tech' },
    { id:'cyber',   name:'امنیت سایبری',          risk:0.20, opp:0.12, unc:0.12, domain:'geo'  },
    { id:'energy',  name:'انرژی‌های نو',          risk:0.17, opp:0.25, unc:0.12, domain:'clim' },
    { id:'urban',   name:'شهرهای هوشمند',         risk:0.12, opp:0.14, unc:0.08, domain:'tech' },
    { id:'fin',     name:'فین‌تک/دارایی دیجیتال', risk:0.22, opp:0.16, unc:0.15, domain:'econ' },
  ];

  const SOURCES = [
    { name:'European Commission JRC Strategic Foresight', domain:'econ', w:0.8 },
    { name:'OECD Strategic Foresight', domain:'econ', w:0.8 },
    { name:'World Economic Forum', domain:'econ', w:0.7 },
    { name:'Brookings Institution', domain:'econ', w:0.7 },
    { name:'RAND Corporation', domain:'geo', w:0.8 },
    { name:'Chatham House (RIIA)', domain:'geo', w:0.8 },
    { name:'CSIS', domain:'geo', w:0.85 },
    { name:'Carnegie Endowment for International Peace', domain:'geo', w:0.75 },
    { name:'Atlantic Council', domain:'geo', w:0.75 },
    { name:'Council on Foreign Relations (CFR)', domain:'geo', w:0.7 },
    { name:'Peterson Institute for International Economics', domain:'econ', w:0.75 },
    { name:'Bruegel', domain:'econ', w:0.8 },
    { name:'CEPS', domain:'econ', w:0.7 },
    { name:'SWP (German Institute for International and Security Affairs)', domain:'geo', w:0.8 },
    { name:'Bertelsmann Stiftung', domain:'soc', w:0.65 },
    { name:'Kiel Institute (IfW Kiel)', domain:'econ', w:0.7 },
    { name:'DIW Berlin', domain:'econ', w:0.7 },
    { name:'Clingendael Institute', domain:'geo', w:0.7 },
    { name:'IFRI', domain:'geo', w:0.7 },
    { name:'IISS', domain:'geo', w:0.75 },
    { name:'SIPRI', domain:'geo', w:0.75 },
    { name:'GMF (German Marshall Fund)', domain:'geo', w:0.7 },
    { name:'MERICS', domain:'geo', w:0.7 },
    { name:'Lowy Institute', domain:'geo', w:0.7 },
    { name:'ASPI', domain:'geo', w:0.7 },
    { name:'NBR', domain:'geo', w:0.7 },
    { name:'Nesta', domain:'tech', w:0.7 },
    { name:'IFTF (Institute for the Future)', domain:'tech', w:0.75 },
    { name:'Oxford Martin School', domain:'tech', w:0.75 },
    { name:'Fraunhofer ISI', domain:'tech', w:0.8 },
    { name:'Copenhagen Institute for Futures Studies', domain:'tech', w:0.75 },
    { name:'McKinsey Global Institute (MGI)', domain:'econ', w:0.8 },
    { name:'EPRS (European Parliamentary Research Service)', domain:'econ', w:0.7 },
    { name:'Carnegie Europe', domain:'geo', w:0.7 },
    { name:'Urban Institute', domain:'soc', w:0.6 },
    { name:'Demos', domain:'soc', w:0.6 },
    { name:'AEI', domain:'econ', w:0.6 }
  ];

  // NEW: Future-proof Jobs dataset (curated, cross-domain)
  const JOBS = [
    {
      id:'ai-product-manager',
      title:'مدیر محصول هوش مصنوعی',
      domain:'tech', aiResist:0.78,
      trends:['ai','data','urban'], // data mapped from 'ai','urban' etc. 'data' virtual
      skillsCore:['Product Strategy','AI Basics','Data Literacy','User Research'],
      skillsPlus:['Prompt Design','A/B Testing','Responsible AI'],
      pathway:[
        {step:'آشنایی AI + فهم مدل‌های مولد', time:'2-3 هفته', cost:'کم'},
        {step:'پروژه MVP با مدل آماده', time:'3-4 هفته', cost:'کم/متوسط'},
        {step:'اعتبارسنجی و اندازه‌گیری', time:'2 هفته', cost:'کم'}
      ]
    },
    {
      id:'ai-safety-governance',
      title:'کارشناس ایمنی و حاکمیت هوش مصنوعی',
      domain:'tech', aiResist:0.86,
      trends:['ai','cyber'],
      skillsCore:['Risk Assessment','Policy','Security Basics'],
      skillsPlus:['Red Teaming','Model Evaluation','Audit'],
      pathway:[
        {step:'مبانی ریسک/سیاست AI', time:'3 هفته', cost:'کم'},
        {step:'تمرین ارزیابی ریسک روی کیس واقعی', time:'3-4 هفته', cost:'کم'},
        {step:'طراحی رویه‌های ممیزی', time:'2 هفته', cost:'کم'}
      ]
    },
    {
      id:'data-analyst-public-health',
      title:'تحلیلگر داده سلامت عمومی',
      domain:'soc', aiResist:0.8,
      trends:['aging','bio'],
      skillsCore:['Statistics','SQL','Public Health Basics'],
      skillsPlus:['GIS','Dashboarding'],
      pathway:[
        {step:'آمار/SQL فشرده', time:'4-6 هفته', cost:'کم/متوسط'},
        {step:'پروژه داشبورد سلامت شهری', time:'3 هفته', cost:'کم'},
        {step:'ارائه به ذی‌نفعان', time:'1 هفته', cost:'کم'}
      ]
    },
    {
      id:'climate-solutions-consultant',
      title:'مشاور راهکارهای اقلیمی و ESG',
      domain:'clim', aiResist:0.82,
      trends:['green','energy'],
      skillsCore:['ESG','Lifecycle Analysis','Stakeholder Mgmt'],
      skillsPlus:['Carbon Accounting','Sustainability Reporting'],
      pathway:[
        {step:'مبانی ESG/حسابرسی کربن', time:'3-4 هفته', cost:'کم'},
        {step:'Case Study شرکت محلی', time:'3 هفته', cost:'کم'},
        {step:'گزارش‌گری و نقشه راه', time:'2 هفته', cost:'کم'}
      ]
    },
    {
      id:'supply-chain-resilience',
      title:'کارشناس تاب‌آوری زنجیره تأمین',
      domain:'econ', aiResist:0.76,
      trends:['supply','geo'],
      skillsCore:['Ops Research','Supplier Risk','Scenario Planning'],
      skillsPlus:['Optimization','Simulation'],
      pathway:[
        {step:'مدیریت ریسک تأمین', time:'3 هفته', cost:'کم'},
        {step:'شبیه‌سازی سناریو (Spreadsheet)', time:'2 هفته', cost:'کم'},
        {step:'طرح تنوع‌بخشی تأمین', time:'2-3 هفته', cost:'کم'}
      ]
    },
    {
      id:'cybersecurity-lead',
      title:'رهبر امنیت سایبری سازمانی',
      domain:'geo', aiResist:0.88,
      trends:['cyber','ai'],
      skillsCore:['Threat Modeling','Zero Trust','IR Plans'],
      skillsPlus:['Cloud Sec','Red/Blue Team'],
      pathway:[
        {step:'مبانی Threat Modeling/Zero Trust', time:'3 هفته', cost:'کم'},
        {step:'تمرین Incident Response', time:'2 هفته', cost:'کم'},
        {step:'سخت‌سازی Cloud/DevSecOps', time:'3 هفته', cost:'متوسط'}
      ]
    },
    {
      id:'human-centered-educator',
      title:'طراح آموزشی انسان‌محور (EdTech)',
      domain:'soc', aiResist:0.74,
      trends:['ed','ai'],
      skillsCore:['Curriculum Design','Assessment','Learning Science'],
      skillsPlus:['Adaptive Tools','Content Ops'],
      pathway:[
        {step:'اصول یادگیری/ارزیابی', time:'3 هفته', cost:'کم'},
        {step:'طراحی دوره کوتاه + ابزار تطبیقی', time:'3 هفته', cost:'کم'},
        {step:'آزمون با 20 فراگیر', time:'2 هفته', cost:'کم'}
      ]
    },
    {
      id:'city-innovation-planner',
      title:'برنامه‌ریز نوآوری شهری',
      domain:'tech', aiResist:0.77,
      trends:['urban','energy','green'],
      skillsCore:['Urban Systems','Project Finance Basics','Policy'],
      skillsPlus:['IoT Basics','Mobility Data'],
      pathway:[
        {step:'مبانی سیستم‌های شهری/سیاست', time:'3-4 هفته', cost:'کم'},
        {step:'پروژه پایلوت (حمل‌ونقل/انرژی)', time:'3 هفته', cost:'کم'},
        {step:'اکوسیستم‌سازی ذی‌نفعان', time:'2 هفته', cost:'کم'}
      ]
    },
    {
      id:'behavioral-product-designer',
      title:'طراح محصول رفتاری',
      domain:'econ', aiResist:0.73,
      trends:['ai','fin'],
      skillsCore:['UX Research','Behavioral Economics','Experimentation'],
      skillsPlus:['Analytics','Ethical Design'],
      pathway:[
        {step:'اصول اقتصاد رفتاری در محصول', time:'2-3 هفته', cost:'کم'},
        {step:'طراحی و تست آزمایش رفتاری', time:'3 هفته', cost:'کم'},
        {step:'تحلیل و نهادینه‌سازی', time:'2 هفته', cost:'کم'}
      ]
    },
    {
      id:'ai-ethics-ombudsperson',
      title:'مسئول اخلاق و سرپرست شکایات AI',
      domain:'soc', aiResist:0.85,
      trends:['ai','cyber'],
      skillsCore:['Ethics','Mediation','Policy'],
      skillsPlus:['Bias Audits','Explainability'],
      pathway:[
        {step:'چارچوب‌های اخلاقی/حقوقی', time:'3 هفته', cost:'کم'},
        {step:'فرآیند رسیدگی به شکایات', time:'2 هفته', cost:'کم'},
        {step:'مکانیزم‌های کاهش بایاس', time:'3 هفته', cost:'کم'}
      ]
    }
  ];

  // ---------- UI Elements ----------
  const decisionEl = document.getElementById('decision');
  const riskEl = document.getElementById('risk');
  const horizonEl = document.getElementById('horizon');
  const profileText = document.getElementById('profileText');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const skillNote = document.getElementById('skillNote');

  const trendChips = document.getElementById('trendChips');
  const selectedTrends = new Set(['ai','green','geo','supply']); // default

  const matrixTableBody = document.querySelector('#matrixTable tbody');
  const sourceChips = document.getElementById('sourceChips');

  const oppVal = document.getElementById('oppVal');
  const oppBar = document.getElementById('oppBar');
  const riskVal = document.getElementById('riskVal');
  const riskBar = document.getElementById('riskBar');
  const uncVal = document.getElementById('uncVal');
  const uncBar = document.getElementById('uncBar');
  const feasVal = document.getElementById('feasVal');
  const feasBar = document.getElementById('feasBar');

  const alertsBox = document.getElementById('alertsBox');

  const radar = document.getElementById('radar');
  const rctx = radar.getContext('2d');

  const whyList = document.getElementById('whyList');
  const whySources = document.getElementById('whySources');
  const timelineSvg = document.getElementById('timelineSvg');
  const scenariosEl = document.getElementById('scenarios');
  const actionsEl = document.getElementById('actions');
  const sourceTableBody = document.querySelector('#sourceTable tbody');
  const futureAnalysis = document.getElementById('futureAnalysis');

  const thrRiskEl = document.getElementById('thrRisk');
  const thrUncEl = document.getElementById('thrUnc');
  const statusEl = document.getElementById('status');

  const saveBtn = document.getElementById('saveBtn');
  const exportBtn = document.getElementById('exportBtn');
  const themeToggle = document.getElementById('themeToggle');

  // NEW: Jobs elements
  const jobsWrap = document.getElementById('jobsWrap');
  const autoPressureEl = document.getElementById('autoPressure');
  const jobCountEl = document.getElementById('jobCount');

  // ---------- Helpers ----------
  const dpi = window.devicePixelRatio || 1;
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function pct(x){ return Math.round(clamp01(x)*100); }

  function renderTrendChips(){
    trendChips.innerHTML = '';
    TRENDS.forEach(t=>{
      const on = selectedTrends.has(t.id);
      const el = document.createElement('span');
      el.className = 'chip';
      el.setAttribute('role','checkbox');
      el.setAttribute('aria-checked', on ? 'true':'false');
      el.style.borderColor = on ? '#2a7b5f' : 'var(--border)';
      el.style.boxShadow = on ? '0 0 18px rgba(126,231,135,0.15) inset' : 'none';
      el.innerHTML = `<span class="dot" style="background:${on?'#7ee787':'#6b7280'}"></span>${t.name}`;
      el.addEventListener('click', ()=>{
        if(on) selectedTrends.delete(t.id); else selectedTrends.add(t.id);
        renderTrendChips(); // no recompute here to let user toggle multiple then simulate
      });
      trendChips.appendChild(el);
    });
  }
  function renderSourceChips(){
    sourceChips.innerHTML='';
    SOURCES.forEach(s=>{
      const clr = s.domain==='econ'?'#7ee787': s.domain==='geo'?'#ffb4b4': s.domain==='tech'?'#7aa2f7': s.domain==='clim'?'#ffd28b':'#c0a6ff';
      const chip = document.createElement('span'); chip.className='chip'; chip.title=s.name;
      chip.innerHTML = `<span class="dot" style="background:${clr}"></span>${s.name}`;
      sourceChips.appendChild(chip);
    });
  }
  renderTrendChips(); renderSourceChips();

  // ---------- Radar ----------
  const DIMENSIONS = [
    { id:'career', label:'شغل/مهارت' },
    { id:'wealth', label:'ثروت/سرمایه' },
    { id:'well', label:'رفاه/سلامت' },
    { id:'impact', label:'پایداری/اثر' },
    { id:'res', label:'تاب‌آوری' },
  ];
  let scores = { career:0.6, wealth:0.55, well:0.58, impact:0.62, res:0.57 };
  let bands  = { career:0.12, wealth:0.1,  well:0.11, impact:0.09, res:0.1  };
  function resizeRadar(){
    const rect = radar.getBoundingClientRect();
    radar.width = rect.width * dpi;
    radar.height = rect.height * dpi;
    rctx.setTransform(dpi,0,0,dpi,0,0);
    drawRadar();
  }
  window.addEventListener('resize', resizeRadar);
  function drawRadar(){
    const w = radar.width/dpi, h = radar.height/dpi;
    rctx.clearRect(0,0,w,h);
    const cx = w/2, cy = h/2 + 8;
    const R = Math.min(w,h)*0.36;

    rctx.save();
    rctx.strokeStyle = 'rgba(180,200,240,0.25)';
    for(let r=1; r<=4; r++){
      rctx.beginPath();
      const rr = R * (r/4);
      DIMENSIONS.forEach((d,i)=>{
        const ang = (Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
        const x=cx+rr*Math.cos(ang), y=cy+rr*Math.sin(ang);
        i===0? rctx.moveTo(x,y) : rctx.lineTo(x,y);
      });
      rctx.closePath(); rctx.stroke();
    }
    DIMENSIONS.forEach((d,i)=>{
      const ang=(Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
      const x=cx+R*Math.cos(ang), y=cy+R*Math.sin(ang);
      rctx.beginPath(); rctx.moveTo(cx,cy); rctx.lineTo(x,y);
      rctx.strokeStyle='rgba(180,200,240,0.18)'; rctx.stroke();
      const lx=cx+(R+18)*Math.cos(ang), ly=cy+(R+18)*Math.sin(ang);
      rctx.fillStyle='#cfe3ff'; rctx.font='12px sans-serif';
      rctx.textAlign = Math.cos(ang)>0.2? 'left' : (Math.cos(ang)<-0.2?'right':'center');
      rctx.fillText(d.label,lx,ly);
    });

    // band
    rctx.beginPath();
    DIMENSIONS.forEach((d,i)=>{
      const v = clamp01(scores[d.id] + bands[d.id]);
      const ang=(Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
      const x=cx+R*v*Math.cos(ang), y=cy+R*v*Math.sin(ang);
      i===0? rctx.moveTo(x,y) : rctx.lineTo(x,y);
    });
    rctx.closePath();
    rctx.fillStyle='rgba(255,210,139,0.18)'; rctx.fill();

    // polygon
    rctx.beginPath();
    DIMENSIONS.forEach((d,i)=>{
      const v = clamp01(scores[d.id]);
      const ang=(Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
      const x=cx+R*v*Math.cos(ang), y=cy+R*v*Math.sin(ang);
      i===0? rctx.moveTo(x,y) : rctx.lineTo(x,y);
    });
    rctx.closePath();
    const grad=rctx.createLinearGradient(0,0,w,h);
    grad.addColorStop(0,'rgba(126,231,135,0.28)');
    grad.addColorStop(1,'rgba(122,162,247,0.28)');
    rctx.fillStyle=grad; rctx.fill();
    rctx.strokeStyle='rgba(126,231,135,0.7)'; rctx.lineWidth=2; rctx.stroke();
    rctx.restore();
  }

  // ---------- Domain weights ----------
  function decisionPrefs(dec){
    switch(dec){
      case 'career': return { tech:0.32, econ:0.22, soc:0.18, geo:0.14, clim:0.14 };
      case 'startup':return { tech:0.30, econ:0.28, soc:0.12, geo:0.14, clim:0.16 };
      case 'invest': return { econ:0.36, geo:0.22, tech:0.20, clim:0.12, soc:0.10 };
      case 'relocate':return{ soc:0.26, econ:0.22, geo:0.22, tech:0.16, clim:0.14 };
      case 'learn':  return { tech:0.36, econ:0.18, soc:0.20, geo:0.12, clim:0.14 };
      default:       return { tech:0.28, econ:0.24, geo:0.18, clim:0.16, soc:0.14 };
    }
  }
  function dynamicDomainWeights(dec, trendSet){
    const base = decisionPrefs(dec);
    const w = { tech:base.tech||0, econ:base.econ||0, geo:base.geo||0, clim:base.clim||0, soc:base.soc||0 };
    trendSet.forEach(id=>{
      const t = TRENDS.find(x=>x.id===id); if(!t) return;
      w[t.domain] += 0.06; // emphasize aligned domain
    });
    const sum = Object.values(w).reduce((a,b)=>a+b,0)||1;
    for(const k in w) w[k]=w[k]/sum;
    return w;
  }
  function renderDomainMatrix(domainWeights, dec){
    matrixTableBody.innerHTML='';
    const notes = { econ:'رشد/تورم/بهره و بازارها', geo:'درگیری‌ها/وابستگی و امنیت', tech:'بهره‌وری/اتوماسیون و رقابت', clim:'مقررات/ESG و انرژی', soc:'جمعیت/مهارت و عدالت' };
    DOMAINS.forEach(d=>{
      const tr=document.createElement('tr');
      const base = decisionPrefs(dec)[d.id]||0;
      const dyn  = domainWeights[d.id]||0;
      tr.innerHTML = `<td>${d.label}</td><td>${base.toFixed(2)}</td><td>${dyn.toFixed(2)}</td><td>${notes[d.id]}</td>`;
      matrixTableBody.appendChild(tr);
    });
  }
  function renderSourceTable(domainWeights){
    sourceTableBody.innerHTML='';
    SOURCES.forEach(s=>{
      const dw = domainWeights[s.domain]||0.2;
      const finalW = (s.w * (0.6 + 0.4*dw));
      const tr = document.createElement('tr');
      const label = DOMAINS.find(d=>d.id===s.domain)?.label || s.domain;
      tr.innerHTML = `<td>${s.name}</td><td>${label}</td><td>${finalW.toFixed(2)}</td><td>${finalW>0.65?'اثر قوی':'اثر متوسط'}</td>`;
      sourceTableBody.appendChild(tr);
    });
  }

  // ---------- Skills parsing ----------
  const SKILL_MAP = [
    { keys:['ai','ml','machine learning','هوش','python','pytorch','tensorflow','data','داده'], dim:'career', delta:0.06, domain:'tech' },
    { keys:['climate','energy','esg','سازگاری','انرژی','اقلیم','پایداری'], dim:'impact', delta:0.05, domain:'clim' },
    { keys:['product','design','ux','ui','figma','طراحی','محصول'], dim:'career', delta:0.03, domain:'tech' },
    { keys:['security','امنیت','cyber','devsecops'], dim:'res', delta:0.05, domain:'geo' },
    { keys:['finance','quant','valuation','مالی','پرتفو','پرتفوی'], dim:'wealth', delta:0.05, domain:'econ' },
    { keys:['health','سلامت','bio','biology'], dim:'well', delta:0.03, domain:'soc' },
  ];
  function analyzeSkills(text){
    const t = (text||'').toLowerCase();
    return SKILL_MAP.filter(s=> s.keys.some(k=>t.includes(k)));
  }
  analyzeBtn.addEventListener('click', ()=>{
    const hits = analyzeSkills(profileText.value);
    if(hits.length===0) skillNote.textContent = 'مهارت مشخصی پیدا نشد. چند کلیدواژه اضافه کن.';
    else {
      const labs = Array.from(new Set(hits.flatMap(h=>h.keys.slice(0,1))));
      skillNote.textContent = `مهارت‌های شناسایی: ${labs.slice(0,6).join(', ')}${hits.length>6? ' +' + (hits.length-6) : ''}`;
    }
  });

  // ---------- Timeline ----------
  function renderTimeline(){
    const years=[2025,2026,2027,2028,2029,2030,2031,2032];
    const w=900,h=140,pad=60; timelineSvg.innerHTML='';
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',pad); line.setAttribute('y1',h/2);
    line.setAttribute('x2',w-pad); line.setAttribute('y2',h/2);
    line.setAttribute('stroke','#2b3a55'); line.setAttribute('stroke-width','2');
    timelineSvg.appendChild(line);
    years.forEach((y,i)=>{
      const x = pad + i*((w-2*pad)/(years.length-1));
      const tick=document.createElementNS('http://www.w3.org/2000/svg','line');
      tick.setAttribute('x1',x); tick.setAttribute('y1',h/2-8);
      tick.setAttribute('x2',x); tick.setAttribute('y2',h/2+8);
      tick.setAttribute('stroke','#3b5177'); tick.setAttribute('stroke-width','2');
      timelineSvg.appendChild(tick);
      const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x',x); txt.setAttribute('y',h/2+28);
      txt.setAttribute('text-anchor','middle'); txt.setAttribute('class','tick');
      txt.textContent=y; timelineSvg.appendChild(txt);
    });
    const markers=[
      { y:2025, label:'MVP/پروتوتایپ مهارت', tone:'#7ee787' },
      { y:2026, label:'اعتبارسنجی بازار/شبکه', tone:'#7aa2f7' },
      { y:2027, label:'گسترش/تنوع‌بخشی', tone:'#ffd28b' },
      { y:2029, label:'تاب‌آوری/ریسک ژئو', tone:'#ffb4b4' },
      { y:2031, label:'استاندارد/ESG', tone:'#aef7d3' },
    ];
    markers.forEach(m=>{
      const i = years.indexOf(m.y); if(i<0) return;
      const x = pad + i*((w-2*pad)/(years.length-1));
      const cy=56;
      const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',x); c.setAttribute('cy',cy); c.setAttribute('r','7'); c.setAttribute('fill',m.tone);
      timelineSvg.appendChild(c);
      const lab=document.createElementNS('http://www.w3.org/2000/svg','text');
      lab.setAttribute('x',x); lab.setAttribute('y',cy-12);
      lab.setAttribute('text-anchor','middle'); lab.setAttribute('class','tick');
      lab.textContent=m.label; timelineSvg.appendChild(lab);
    });
  }

  // ---------- Alerts ----------
  function renderAlerts(systemicRisk, unc, activeTrends){
    alertsBox.innerHTML='';
    const thrR = parseFloat(thrRiskEl.value)||0.6;
    const thrU = parseFloat(thrUncEl.value)||0.7;
    const ids = new Set(activeTrends);
    const push = (cls, txt) => {
      const el=document.createElement('div'); el.className='alert '+cls; el.innerHTML = `⚠️ ${txt}`; alertsBox.appendChild(el);
    };
    if(systemicRisk>=thrR) push('danger','ریسک سیستمی بالاست. پوشش‌ریسک و گزینه توقف سریع تعریف کن.');
    if(unc>=thrU) push('warn','عدم‌قطعیت زیاد است؛ آزمایش‌های کوچک، تصمیم‌های قابل‌برگشت.');
    if(ids.has('geo') && ids.has('energy')) push('warn','ترکیب ژئو + انرژی می‌تواند نوسان زیرساخت/قیمت بسازد. برنامه انعطاف‌پذیری آماده کن.');
    if(ids.has('ai') && ids.has('cyber')) push('warn','اتوماسیون + ریسک سایبری: کنترل دسترسی/ممیزی داده را تقویت کن.');
    if(!alertsBox.children.length){
      const ok=document.createElement('div'); ok.className='alert ok';
      ok.textContent='وضعیت پایدار: هشدار فعالی وجود ندارد. پایش مستمر ادامه یابد.'; alertsBox.appendChild(ok);
    }
  }

  // ---------- Actions ----------
  function renderActions(decision, riskTol){
    const acts=[];
    acts.push({
      horizon:'۳۰ روزه',
      title: decision==='career' ? 'نمونه‌کار هدفمند + ۳ گفت‌وگوی اطلاعاتی' :
             decision==='startup'? 'مصاحبه ۱۰ مشتری + MVP کاغذی' :
             decision==='invest' ? 'IPS یک‌صفحه‌ای + معیارهای ریسک' :
             decision==='relocate'? 'تحلیل ۳ شهر با ماتریس امتیازدهی' :
             'دوره ۲۰ ساعته مهارت کلیدی + تمرین',
      tip: decision==='startup'? 'معیار درد/تکرار/بودجه را برای اولویت مشکل بسنج.' :
           decision==='career' ? '۳ شغل هدف = ۳ نمونه‌کار مطابق JD.' :
           'بازخورد سریع بگیر و مسیر را اصلاح کن.',
      impact:'اثر: متوسط', difficulty:'دشواری: کم'
    });
    acts.push({
      horizon:'۹۰ روزه',
      title: decision==='career' ? 'گواهی معتبر + ۲ پروژه مشترک/متن‌باز' :
             decision==='startup'? 'MVP واقعی + ۳۰ کاربر آزمایشی' :
             decision==='invest' ? 'تنوع‌بخشی + سقف زیان تعریف‌شده' :
             decision==='relocate'? 'سفر اکتشافی + رویداد شبکه محلی' :
             'پروژه capstone با منتور',
      tip:'یک شاخص موفقیت واحد انتخاب کن و هفتگی پایش کن.',
      impact:'اثر: بالا', difficulty:'دشواری: متوسط'
    });
    acts.push({
      horizon:'۱۸۰ روزه',
      title: decision==='career' ? 'جایگذاری در نقش هدف/ارتقا' :
             decision==='startup'? 'MRR با چرخه ساخت/اندازه‌گیری' :
             decision==='invest' ? 'پوشش‌ریسک حداقلی + بازمتوازن‌سازی' :
             decision==='relocate'? 'جابجایی با برنامه مالی/اجتماعی' :
             'ارائه عمومی + شبکه حامیان',
      tip: riskTol==='high' ? 'آزمایش‌های آپساید با سقف زیان مشخص.' : 'ذخیره زمانی/مالی برای تاب‌آوری نگه‌دار.',
      impact:'اثر: بسیار بالا', difficulty:'دشواری: متوسط/بالا'
    });

    actionsEl.innerHTML='';
    acts.forEach(a=>{
      const card=document.createElement('div'); card.className='actionCard';
      card.innerHTML=`
        <div class="pill"><span style="width:8px;height:8px;background:#7aa2f7;border-radius:50%"></span>${a.horizon}</div>
        <div style="font-weight:700">${a.title}</div>
        <div class="hint">${a.tip}</div>
        <div class="row" style="justify-content:space-between;margin-top:4px">
          <span class="pill impact">⚡ ${a.impact}</span>
          <span class="pill difficulty">🧩 ${a.difficulty}</span>
        </div>`;
      actionsEl.appendChild(card);
    });
  }

  // ---------- Scenarios ----------
  function renderScenarios(dec, risk, opp, unc){
    const baseP = clamp01(0.6 - (unc-0.4)*0.5);
    const upP   = clamp01(0.2 + (opp-0.55)*0.4);
    const downP = clamp01(0.2 + (risk-0.45)*0.5);
    const sum = baseP+upP+downP || 1;
    const P = { up: upP/sum, base: baseP/sum, down: downP/sum };

    const defs = [
      { id:'up',   label:'Upside (اثر زیاد/احتمال کم
