<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>آینه آینده X — نسخه MVP</title>
  <style>
    :root{
      --bg:#0b0f14; --bg2:#0f1520; --glass:rgba(255,255,255,0.06);
      --text:#e9efff; --muted:#9fb0cc; --accent:#7ee787; --accent2:#7aa2f7; --warn:#ffb86b; --risk:#ff6b6b;
      --chip:#1c2433; --chipText:#cfe3ff; --card:#0f1722; --border:rgba(255,255,255,0.12);
      --good:#27c498; --neutral:#b5c2d9; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: IRANSans, Segoe UI, Roboto, sans-serif;
      color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #162033, #0b0f14 60%) fixed;
      overflow-x:hidden;
    }
    /* Starfield canvas background */
    #bgCanvas{position:fixed; inset:0; z-index:-1; filter: saturate(110%) brightness(110%)}

    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:20px 24px; position:sticky; top:0; background:linear-gradient(180deg, rgba(11,15,20,0.9), rgba(11,15,20,0.6) 60%, transparent);
      backdrop-filter: blur(6px); border-bottom:1px solid var(--border); z-index:2;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:34px;height:34px;border-radius:10px; background:
        radial-gradient(80% 80% at 30% 30%, #7ee78744, transparent 70%),
        linear-gradient(135deg, #24344a, #141c29);
      border:1px solid var(--border); box-shadow:0 0 30px #7ee78722 inset, 0 0 12px #7ee78722;
    }
    h1{font-size:18px; margin:0; letter-spacing:0.3px}
    .header-actions{display:flex; gap:8px}
    .btn{
      padding:10px 14px; border:1px solid var(--border); border-radius:10px; color:var(--text);
      background: linear-gradient(180deg, #172033, #121a28); cursor:pointer;
      transition: all .2s ease; font-size:14px;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 6px 20px rgba(0,0,0,0.25)}
    .btn.primary{border-color:#2a7b5f; background:linear-gradient(180deg, #1a3b34, #112822); color:#aef7d3}
    .btn.ghost{background:transparent}
    .container{max-width:1180px; margin:16px auto 80px; padding:0 20px}
    .grid{
      display:grid; grid-template-columns: 340px 1fr; gap:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border:1px solid var(--border); border-radius:16px; padding:16px 16px 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .panel h2{font-size:16px; margin:0 0 10px 0; color:#cfe3ff}
    .panel p{color:var(--muted); margin:8px 0 12px 0; line-height:1.7}
    .field{margin:10px 0}
    .field label{display:block; color:#cfe3ff; font-size:13px; margin-bottom:6px}
    .input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#0e1420; color:var(--text); outline:none; transition:border .2s ease;
    }
    .row{display:flex; gap:10px}
    .row .col{flex:1}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      border:1px solid var(--border); background:var(--chip); color:var(--chipText);
      font-size:12px; padding:6px 10px; border-radius:999px; display:inline-flex; align-items:center; gap:6px
    }
    .chip .dot{width:7px; height:7px; border-radius:999px; background:var(--accent); box-shadow:0 0 10px var(--accent)}
    .muted{color:var(--muted)}
    .section{margin-top:16px}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .card{
      flex:1 1 160px; background:linear-gradient(180deg, #0e1420, #0b1018);
      border:1px solid var(--border); border-radius:14px; padding:12px
    }
    .kpi .title{font-size:12px; color:#b7c7e8; margin-bottom:6px}
    .kpi .value{font-size:22px; font-weight:700}
    .kpi .trend{font-size:12px}
    .good{color:var(--good)} .bad{color:var(--bad)} .neutral{color:var(--neutral)}

    /* Radar + uncertainty */
    .viz{display:grid; grid-template-columns: 1.2fr 1fr; gap:12px}
    @media (max-width: 980px){ .viz{grid-template-columns: 1fr} }
    .canvasWrap{position:relative; background:linear-gradient(180deg, rgba(15,21,32,0.8), rgba(10,14,22,0.6)); border:1px solid var(--border); border-radius:14px; padding:8px}
    #radar{width:100%; height:380px}
    .legend{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .legend .chip{background:#0e1726}
    .why{
      background: linear-gradient(180deg, #0e1522, #0c111b);
      border:1px solid var(--border); border-radius:14px; padding:12px;
      display:flex; flex-direction:column; gap:10px; max-height:420px; overflow:auto
    }
    .why h3{margin:0 0 2px 0; font-size:14px; color:#cfe3ff}
    .why .reason{display:flex; align-items:flex-start; gap:10px; border-bottom:1px dashed var(--border); padding-bottom:8px}
    .why .reason:last-child{border-bottom:none}
    .bar{height:6px; background:#122036; border-radius:8px; overflow:hidden}
    .bar > span{display:block; height:100%; background: linear-gradient(90deg, #7ee787, #7aa2f7)}
    .why .srcs{display:flex; flex-wrap:wrap; gap:8px}
    .why .srcs .chip{background:#101a2b}

    /* Timeline */
    .timeline{background:linear-gradient(180deg, #0e1522, #0c111b); border:1px solid var(--border); border-radius:14px; padding:12px}
    .timeline svg{width:100%; height:140px}
    .tick text{fill:#a9bfde; font-size:12px}

    /* Actions */
    .actions{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
    @media (max-width: 820px){ .actions{grid-template-columns:1fr} }
    .actionCard{
      background:linear-gradient(180deg, #0f1726, #0c131f);
      border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:8px
    }
    .pill{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:#bcd2f0; display:inline-flex; gap:6px; align-items:center}
    .impact{color:#aef7d3} .difficulty{color:#ffd28b}
    .foot{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:6px}

    /* Footer */
    footer{margin:30px 0 60px; color:#89a1c5; font-size:12px; text-align:center}
    .toggle{
      display:inline-flex; align-items:center; gap:8px; font-size:13px; color:#cfe3ff; cursor:pointer
    }
    .toggle input{accent-color:#7ee787; width:18px; height:18px}
    .hint{font-size:12px; color:#9fb0cc}

    /* Light theme */
    body.light{
      --bg:#f7fbff; --bg2:#eef5ff; --glass:rgba(0,0,0,0.05); --text:#0d1b2a; --muted:#3f5877;
      --chip:#e7eefc; --chipText:#0d1b2a; --card:#f0f6ff; --border:rgba(0,0,0,0.12);
      --accent:#0ea5a5; --accent2:#2563eb; --warn:#f59e0b; --risk:#ef4444;
      --good:#059669; --neutral:#64748b; --bad:#ef4444;
      background: radial-gradient(1200px 600px at 70% -10%, #e6f1ff, #f7fbff 60%) fixed;
    }
    body.light #bgCanvas{filter: none}
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>

  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>آینه آینده X — نسخه MVP</h1>
        <div class="muted" style="font-size:12px">شبیه‌ساز سناریوهای شخصی با شواهد اندیشکده‌ها</div>
      </div>
    </div>
    <div class="header-actions">
      <button id="saveBtn" class="btn">ذخیره سناریو</button>
      <button id="exportBtn" class="btn">خروجی PDF</button>
      <label class="toggle">
        <input id="themeToggle" type="checkbox"/> حالت روشن
      </label>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Left: Inputs and source chips -->
      <div class="panel">
        <h2>پروفایل و تصمیم</h2>
        <div class="field">
          <label>هدف تصمیم</label>
          <select id="decision">
            <option value="career">تغییر مسیر شغلی</option>
            <option value="startup">راه‌اندازی استارتاپ</option>
            <option value="invest">سرمایه‌گذاری شخصی</option>
            <option value="relocate">جابجایی/مهاجرت</option>
            <option value="learn">یادگیری مهارت جدید</option>
          </select>
        </div>
        <div class="row">
          <div class="col field">
            <label>تحمل ریسک</label>
            <select id="risk">
              <option value="low">پایین</option>
              <option value="mid" selected>متوسط</option>
              <option value="high">بالا</option>
            </select>
          </div>
          <div class="col field">
            <label>افق زمانی</label>
            <select id="horizon">
              <option value="6">۶ ماه</option>
              <option value="12" selected>۱۲ ماه</option>
              <option value="24">۲۴ ماه</option>
              <option value="36">۳۶ ماه</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label>زمینه/مهارت‌های کلیدی</label>
          <input id="skills" class="input" placeholder="مثال: Data, AI, انرژی پاک، طراحی محصول"/>
        </div>
        <div class="field">
          <label>ترندهای مدنظر</label>
          <div class="chips" id="trendChips">
            <!-- generated -->
          </div>
          <div class="hint">ترندها را روشن/خاموش کن تا اثرشان بر سناریو و عدم‌قطعیت را ببینی.</div>
        </div>
        <div class="section">
          <h2>منابع و اندیشکده‌ها</h2>
          <p class="muted">این نسخه از مجموعه‌ای از اندیشکده‌ها/مراکز پژوهشی الهام می‌گیرد. در نسخه کامل، وزن‌ها به‌صورت پویا بر اساس موضوع تنظیم می‌شوند.</p>
          <div class="chips" id="sourceChips">
            <!-- 30+ sources -->
          </div>
        </div>
      </div>

      <!-- Right: Visualization and outputs -->
      <div class="panel">
        <h2>جمع‌بندی سناریو</h2>
        <div class="kpi">
          <div class="card">
            <div class="title">شاخص فرصت</div>
            <div id="oppVal" class="value">—</div>
            <div id="oppTrend" class="trend good">—</div>
          </div>
          <div class="card">
            <div class="title">ریسک سیستمی</div>
            <div id="riskVal" class="value">—</div>
            <div id="riskNote" class="trend bad">—</div>
          </div>
          <div class="card">
            <div class="title">عدم‌قطعیت</div>
            <div id="uncVal" class="value">—</div>
            <div class="trend neutral">هرچه بالاتر، بازه پیش‌بینی پهن‌تر</div>
          </div>
        </div>

        <div class="section viz">
          <div class="canvasWrap">
            <canvas id="radar"></canvas>
            <div class="legend">
              <span class="chip"><span class="dot"></span> امتیاز</span>
              <span class="chip" style="--accent:#ffd28b"><span class="dot" style="background:#ffd28b; box-shadow:0 0 10px #ffd28b"></span> باند عدم‌قطعیت</span>
            </div>
          </div>
          <div class="why">
            <h3>چرا این نتیجه؟</h3>
            <div id="whyList">
              <!-- reasons -->
            </div>
            <div>
              <div class="muted" style="margin:4px 0 6px">منابع مؤثر:</div>
              <div class="srcs" id="whySources"></div>
            </div>
          </div>
        </div>

        <div class="section timeline">
          <h2>نقشه زمان 2025–2032</h2>
          <svg id="timelineSvg" viewBox="0 0 900 140" preserveAspectRatio="xMidYMid meet"></svg>
        </div>

        <div class="section">
          <h2>گام‌های پیشنهادی</h2>
          <div class="actions" id="actions">
            <!-- 30/90/180 -->
          </div>
        </div>
      </div>
    </div>
    <footer>
      نسخه MVP نمایشی. وزن‌دهی منابع، اتصال به داده‌های زنده و توصیه‌های تخصصی قابل افزودن در گام بعدی.
    </footer>
  </div>

  <script>
    // ---------------------------
    // Data: Trends and Sources
    // ---------------------------
    const TRENDS = [
      { id:'ai', name:'هوش مصنوعی مولد', risk:0.2, opp:0.35, unc:0.15 },
      { id:'green', name:'گذار سبز و کربن‌صفر', risk:0.18, opp:0.28, unc:0.14 },
      { id:'geo', name:'ریسک ژئوپلیتیک', risk:0.35, opp:-0.05, unc:0.22 },
      { id:'supply', name:'بازآرایی زنجیره تأمین', risk:0.22, opp:0.18, unc:0.12 },
      { id:'aging', name:'سالمندی جمعیت', risk:0.25, opp:0.05, unc:0.1 },
      { id:'bio', name:'همگرایی بیو/دیجیتال', risk:0.15, opp:0.22, unc:0.12 },
      { id:'cyber', name:'امنیت سایبری', risk:0.2, opp:0.12, unc:0.12 },
      { id:'energy', name:'انرژی‌های نو', risk:0.17, opp:0.25, unc:0.12 },
      { id:'urban', name:'شهرهای هوشمند', risk:0.12, opp:0.14, unc:0.08 },
      { id:'fin', name:'فین‌تک/دارایی‌های دیجیتال', risk:0.22, opp:0.16, unc:0.15 },
    ];

    const SOURCES = [
      'European Commission JRC Strategic Foresight',
      'OECD Strategic Foresight',
      'World Economic Forum',
      'Brookings Institution',
      'RAND Corporation',
      'Chatham House (RIIA)',
      'CSIS',
      'Carnegie Endowment for International Peace',
      'Atlantic Council',
      'Council on Foreign Relations (CFR)',
      'Peterson Institute for International Economics (PIIE)',
      'Bruegel',
      'CEPS (Centre for European Policy Studies)',
      'SWP (German Institute for International and Security Affairs)',
      'Bertelsmann Stiftung',
      'Kiel Institute (IfW Kiel)',
      'DIW Berlin',
      'Clingendael Institute',
      'IFRI (Institut français des relations internationales)',
      'IISS (International Institute for Strategic Studies)',
      'SIPRI',
      'GMF (German Marshall Fund)',
      'MERICS',
      'Lowy Institute',
      'ASPI (Australian Strategic Policy Institute)',
      'NBR (The National Bureau of Asian Research)',
      'Hoover Institution',
      'AEI (American Enterprise Institute)',
      'Cato Institute',
      'Heritage Foundation',
      'Urban Institute',
      'Nesta',
      'Demos',
      'Institute for the Future (IFTF)',
      'Oxford Martin School',
      'Fraunhofer ISI',
      'Copenhagen Institute for Futures Studies (CIFS)',
      'McKinsey Global Institute (MGI)',
      'EPRS (European Parliamentary Research Service)',
      'Carnegie Europe'
    ];

    // ---------------------------
    // UI Setup
    // ---------------------------
    const trendChips = document.getElementById('trendChips');
    const sourceChips = document.getElementById('sourceChips');

    const selectedTrends = new Set(['ai','green','geo','supply']); // defaults

    function renderTrendChips(){
      trendChips.innerHTML = '';
      TRENDS.forEach(t=>{
        const on = selectedTrends.has(t.id);
        const el = document.createElement('span');
        el.className = 'chip';
        el.style.borderColor = on ? '#2a7b5f' : 'var(--border)';
        el.style.boxShadow = on ? '0 0 18px rgba(126,231,135,0.15) inset' : 'none';
        el.style.cursor = 'pointer';
        el.innerHTML = `<span class="dot" style="background:${on?'#7ee787':'#6b7280'}; box-shadow:0 0 10px ${on?'#7ee787':'#6b728033'}"></span>${t.name}`;
        el.onclick = ()=>{ if(on) selectedTrends.delete(t.id); else selectedTrends.add(t.id); renderTrendChips(); recompute(); };
        trendChips.appendChild(el);
      });
    }

    function renderSourceChips(){
      sourceChips.innerHTML = '';
      SOURCES.forEach((s,i)=>{
        const el = document.createElement('span');
        el.className = 'chip';
        el.title = s;
        el.innerHTML = `<span class="dot" style="background:${i%2? '#7aa2f7':'#7ee787'}"></span>${s}`;
        sourceChips.appendChild(el);
      });
    }

    renderTrendChips();
    renderSourceChips();

    // ---------------------------
    // Radar Chart
    // ---------------------------
    const radar = document.getElementById('radar');
    const rctx = radar.getContext('2d');
    let dpi = window.devicePixelRatio || 1;
    function resizeRadar(){
      const rect = radar.getBoundingClientRect();
      radar.width = rect.width * dpi;
      radar.height = rect.height * dpi;
      rctx.setTransform(dpi,0,0,dpi,0,0);
      drawRadar();
    }
    window.addEventListener('resize', resizeRadar);

    const DIMENSIONS = [
      { id:'career', label:'شغل و مهارت' },
      { id:'wealth', label:'سرمایه و ثروت' },
      { id:'well', label:'رفاه و سلامت' },
      { id:'impact', label:'پایداری و اثر' },
      { id:'res', label:'تاب‌آوری' },
    ];

    let scores = { career:0.6, wealth:0.55, well:0.58, impact:0.62, res:0.57 };
    let bands =  { career:0.12, wealth:0.1, well:0.11, impact:0.09, res:0.1 };

    function drawRadar(){
      const w = radar.width/dpi, h = radar.height/dpi;
      rctx.clearRect(0,0,w,h);
      const cx = w/2, cy = h/2 + 8;
      const radius = Math.min(w,h)*0.36;

      // grid
      rctx.save();
      rctx.strokeStyle = 'rgba(180,200,240,0.25)';
      rctx.lineWidth = 1;
      for(let g=1; g<=4; g++){
        rctx.beginPath();
        const r = radius * (g/4);
        for(let i=0;i<DIMENSIONS.length;i++){
          const a = (Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
          const x = cx + r*Math.cos(a), y = cy + r*Math.sin(a);
          i===0 ? rctx.moveTo(x,y) : rctx.lineTo(x,y);
        }
        rctx.closePath(); rctx.stroke();
      }
      // axes and labels
      DIMENSIONS.forEach((d,i)=>{
        const a = (Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
        const x = cx + radius*Math.cos(a), y = cy + radius*Math.sin(a);
        rctx.beginPath(); rctx.moveTo(cx,cy); rctx.lineTo(x,y); rctx.strokeStyle='rgba(180,200,240,0.15)'; rctx.stroke();
        // label
        const lx = cx + (radius+18)*Math.cos(a), ly = cy + (radius+18)*Math.sin(a);
        rctx.fillStyle = '#cfe3ff'; rctx.font = '12px sans-serif'; rctx.textAlign = Math.cos(a)>0.2? 'left' : (Math.cos(a)<-0.2? 'right':'center');
        rctx.fillText(d.label, lx, ly);
      });

      // uncertainty band
      rctx.beginPath();
      DIMENSIONS.forEach((d,i)=>{
        const a = (Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
        const r = radius * Math.min(1, Math.max(0, scores[d.id] + bands[d.id]));
        const x = cx + r*Math.cos(a), y = cy + r*Math.sin(a);
        i===0 ? rctx.moveTo(x,y) : rctx.lineTo(x,y);
      });
      rctx.closePath();
      rctx.fillStyle = 'rgba(255,210,139,0.18)';
      rctx.fill();

      // score polygon
      rctx.beginPath();
      DIMENSIONS.forEach((d,i)=>{
        const a = (Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
        const r = radius * Math.min(1, Math.max(0, scores[d.id]));
        const x = cx + r*Math.cos(a), y = cy + r*Math.sin(a);
        i===0 ? rctx.moveTo(x,y) : rctx.lineTo(x,y);
      });
      rctx.closePath();
      const grad = rctx.createLinearGradient(0,0,w,h);
      grad.addColorStop(0,'rgba(126,231,135,0.28)');
      grad.addColorStop(1,'rgba(122,162,247,0.28)');
      rctx.fillStyle = grad; rctx.fill();
      rctx.strokeStyle = 'rgba(126,231,135,0.7)';
      rctx.lineWidth = 2; rctx.stroke();

      rctx.restore();
    }
    resizeRadar();

    // ---------------------------
    // Starfield background (Canvas 2D)
    // ---------------------------
    const bg = document.getElementById('bgCanvas');
    const bctx = bg.getContext('2d');
    let stars = [];
    function resizeBg(){
      bg.width = innerWidth * dpi;
      bg.height = innerHeight * dpi;
      bctx.setTransform(dpi,0,0,dpi,0,0);
      stars = Array.from({length: 180}, ()=>({
        x: Math.random()*innerWidth,
        y: Math.random()*innerHeight,
        z: Math.random()*1.2 + 0.2,
        s: Math.random()*1.5 + 0.3
      }));
    }
    function tickBg(time){
      bctx.clearRect(0,0,innerWidth,innerHeight);
      stars.forEach(st=>{
        st.y += st.z*0.15; if(st.y>innerHeight) { st.y=-5; st.x=Math.random()*innerWidth; }
        bctx.fillStyle = `rgba(${180 + st.z*50}, ${210}, 255, ${0.35+st.z*0.4})`;
        bctx.beginPath(); bctx.arc(st.x, st.y, st.s, 0, Math.PI*2); bctx.fill();
      });
      requestAnimationFrame(tickBg);
    }
    resizeBg(); requestAnimationFrame(tickBg);
    addEventListener('resize', resizeBg);

    // ---------------------------
    // Timeline SVG
    // ---------------------------
    function renderTimeline(){
      const svg = document.getElementById('timelineSvg');
      const years = [2025,2026,2027,2028,2029,2030,2031,2032];
      const w = 900, h = 140, pad = 60;
      svg.innerHTML='';
      // axis
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', pad); line.setAttribute('y1', h/2);
      line.setAttribute('x2', w-pad); line.setAttribute('y2', h/2);
      line.setAttribute('stroke', '#2b3a55'); line.setAttribute('stroke-width','2');
      svg.appendChild(line);

      years.forEach((y,i)=>{
        const x = pad + i*((w-2*pad)/(years.length-1));
        const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
        tick.setAttribute('x1', x); tick.setAttribute('y1', h/2 - 8);
        tick.setAttribute('x2', x); tick.setAttribute('y2', h/2 + 8);
        tick.setAttribute('stroke','#3b5177'); tick.setAttribute('stroke-width','2');
        svg.appendChild(tick);

        const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x', x); txt.setAttribute('y', h/2 + 28);
        txt.setAttribute('text-anchor','middle'); txt.setAttribute('class','tick');
        txt.textContent = y;
        svg.appendChild(txt);
      });

      // scenario markers
      const markers = [
        { y:2025, label:'MVP مهارت/پروتوتایپ', tone:'#7ee787' },
        { y:2026, label:'اعتبارسنجی بازار/شبکه', tone:'#7aa2f7' },
        { y:2027, label:'گسترش/تنوع‌بخشی', tone:'#ffd28b' },
        { y:2029, label:'تاب‌آوری/ریسک ژئو', tone:'#ffb4b4' },
        { y:2031, label:'استانداردسازی/ESG', tone:'#aef7d3' },
      ];
      markers.forEach(m=>{
        const i = years.indexOf(m.y);
        if(i<0) return;
        const x = pad + i*((w-2*pad)/(years.length-1));
        const cy = 56;
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', x); c.setAttribute('cy', cy); c.setAttribute('r','7');
        c.setAttribute('fill', m.tone); c.setAttribute('opacity','0.9');
        svg.appendChild(c);

        const lab = document.createElementNS('http://www.w3.org/2000/svg','text');
        lab.setAttribute('x', x); lab.setAttribute('y', cy - 12);
        lab.setAttribute('text-anchor','middle'); lab.setAttribute('class','tick');
        lab.textContent = m.label;
        svg.appendChild(lab);
      });
    }
    renderTimeline();

    // ---------------------------
    // Scenario logic
    // ---------------------------
    const decisionEl = document.getElementById('decision');
    const riskEl = document.getElementById('risk');
    const horizonEl = document.getElementById('horizon');
    const skillsEl = document.getElementById('skills');

    const oppVal = document.getElementById('oppVal');
    const oppTrend = document.getElementById('oppTrend');
    const riskVal = document.getElementById('riskVal');
    const riskNote = document.getElementById('riskNote');
    const uncVal = document.getElementById('uncVal');

    const whyList = document.getElementById('whyList');
    const whySources = document.getElementById('whySources');
    const actionsEl = document.getElementById('actions');

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function baseByDecision(dec){
      // baseline profiles for different decisions
      switch(dec){
        case 'career': return { career:0.62, wealth:0.55, well:0.60, impact:0.58, res:0.57 };
        case 'startup': return { career:0.58, wealth:0.60, well:0.52, impact:0.64, res:0.55 };
        case 'invest': return { career:0.52, wealth:0.65, well:0.56, impact:0.50, res:0.58 };
        case 'relocate': return { career:0.60, wealth:0.56, well:0.62, impact:0.55, res:0.60 };
        case 'learn': return { career:0.66, wealth:0.54, well:0.60, impact:0.58, res:0.56 };
      }
      return { career:0.58, wealth:0.58, well:0.58, impact:0.58, res:0.58 };
    }

    function computeUncertainty(riskTolerance, horizon, trendSet){
      let u = 0.1 + (horizon/36)*0.12; // longer horizon -> more uncertainty
      if(riskTolerance==='low') u += 0.04;
      if(riskTolerance==='high') u -= 0.02;
      // trends effect
      trendSet.forEach(id=>{
        const t = TRENDS.find(x=>x.id===id);
        if(!t) return;
        u += t.unc * 0.5 / (2 + trendSet.size*0.3);
      });
      return clamp01(u);
    }

    function computeScores(){
      const dec = decisionEl.value;
      const riskTol = riskEl.value;
      const horizon = Number(horizonEl.value);
      const skills = (skillsEl.value || '').toLowerCase();

      // start from baseline by decision
      scores = baseByDecision(dec);
      let opportunity = 0.58, systemicRisk = 0.38;

      // trends contribution
      selectedTrends.forEach(id=>{
        const t = TRENDS.find(x=>x.id===id);
        if(!t) return;
        opportunity += t.opp * 0.42/(1 + selectedTrends.size*0.25);
        systemicRisk += t.risk * 0.50/(1 + selectedTrends.size*0.25);

        // distribute to dimensions heuristically
        scores.career += (t.opp - t.risk*0.15)*0.20;
        scores.wealth += (t.opp - t.risk*0.10)*0.24;
        scores.impact += (t.opp)*0.22;
        scores.res += (0.12 - t.risk*0.18);
        scores.well += (0.08 - t.risk*0.06);
      });

      // skills effect
      const skillMap = [
        { key:['ai','ml','data','هوش','داده'], dim:'career', delta:0.06 },
        { key:['climate','energy','esg','انرژی','اقلیم'], dim:'impact', delta:0.05 },
        { key:['product','design','طراحی','محصول'], dim:'career', delta:0.03 },
        { key:['security','امنیت','cyber'], dim:'res', delta:0.05 },
        { key:['finance','quant','مالی'], dim:'wealth', delta:0.05 },
      ];
      skillMap.forEach(m=>{
        if(m.key.some(k=>skills.includes(k))){
          scores[m.dim] += m.delta;
          opportunity += m.delta*0.6;
        }
      });

      // risk tolerance scaling
      const riskScale = riskTol==='low'? -0.04 : (riskTol==='high'? +0.03 : 0);
      systemicRisk = clamp01(systemicRisk + riskScale);

      // horizon dampen opportunity for very short horizons
      if(horizon<=6) opportunity -= 0.03;

      // normalize and set bands
      for(const k in scores) scores[k] = clamp01(scores[k]);
      const unc = computeUncertainty(riskTol, horizon, selectedTrends);

      const bandBase = unc*0.22;
      bands = {
        career: bandBase * 0.95,
        wealth: bandBase * 1.00,
        well:   bandBase * 0.9,
        impact: bandBase * 0.85,
        res:    bandBase * 0.95,
      };

      // KPIs
      oppVal.textContent = Math.round(clamp01(opportunity)*100) + '%';
      oppTrend.textContent = opportunity>0.58? 'صعود ملایم' : 'نیاز به بهبود';
      oppTrend.className = 'trend ' + (opportunity>0.58? 'good':'neutral');
      riskVal.textContent = Math.round(systemicRisk*100) + '%';
      riskNote.textContent = systemicRisk>0.55? 'ریسک بالاتر از حد نرمال' : (systemicRisk<0.35? 'ریسک کنترل‌شده' : 'ریسک متوسط');
      riskNote.className = 'trend ' + (systemicRisk>0.55? 'bad' : (systemicRisk<0.35? 'good':'neutral'));
      uncVal.textContent = Math.round(unc*100) + '%';

      drawRadar();
      renderWhy(dec, riskTol, horizon, unc);
      renderActions(dec, riskTol, horizon);
    }

    function renderWhy(dec, riskTol, horizon, unc){
      const reasons = [
        { title:'اثر ترندهای فعال', detail:`ترکیب ترندهای انتخابی بر فرصت/ریسک اثر گذاشته است. افزایش عدم‌قطعیت: ${Math.round(unc*100)}%` , weight:0.34 },
        { title:'تناسب تصمیم با مهارت‌ها', detail:'مهارت‌های واردشده با تصمیم مدنظر نگاشت شده‌اند؛ شکاف‌ها به‌صورت هدفمند در گام‌ها پوشش داده می‌شود.', weight:0.26 },
        { title:'افق زمانی', detail:`افق ${horizon} ماهه دامنه باند عدم‌قطعیت را تغییر داده است.`, weight:0.18 },
        { title:'تحمل ریسک', detail:`تنظیم ریسک ${riskTol==='low'?'محافظه‌کارانه':(riskTol==='high'?'تهاجمی':'متعادل')} بر وزن‌دهی اثرگذار بوده است.`, weight:0.12 },
        { title:'میانگین تاریخی سناریوهای مشابه', detail:'پروفایل‌های همسو در ۲۴ ماه گذشته خروجی‌های نزدیک داشته‌اند (Heuristic).', weight:0.10 },
      ];
      whyList.innerHTML = '';
      reasons.forEach(r=>{
        const row = document.createElement('div');
        row.className = 'reason';
        row.innerHTML = `
          <div style="min-width:8px; height:8px; background:#7ee787; border-radius:50%; margin-top:6px"></div>
          <div style="flex:1">
            <div style="color:#cfe3ff; font-size:13px; margin-bottom:4px">${r.title}</div>
            <div class="muted" style="font-size:12px; margin-bottom:8px">${r.detail}</div>
            <div class="bar"><span style="width:${Math.round(r.weight*100)}%"></span></div>
          </div>
        `;
        whyList.appendChild(row);
      });

      // attach source chips subset (simulate relevance)
      whySources.innerHTML = '';
      const hash = (decisionEl.value + riskTol + horizon).length;
      const take = 14; // show 14 contributing sources
      for(let i=0;i<take;i++){
        const s = SOURCES[(hash + i*3) % SOURCES.length];
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span class="dot" style="background:${i%3===0?'#7ee787':(i%3===1?'#7aa2f7':'#ffd28b')}"></span>${s}`;
        whySources.appendChild(chip);
      }
    }

    function renderActions(decision, riskTol, horizon){
      const acts = [];
      // 30 days
      acts.push({
        horizon:'۳۰ روزه',
        title: decision==='career' ? 'نمونه‌کار هدفمند + ۳ گفت‌وگوی اطلاعاتی' :
               decision==='startup' ? 'مصاحبه ۱۰ مشتری + یک MVP کاغذی' :
               decision==='invest' ? 'سند خط‌مشی سرمایه‌گذاری شخصی (IPS) ۱ صفحه‌ای' :
               decision==='relocate' ? 'تحلیل ۳ شهر هدف با معیار هزینه/کیفیت/شبکه' :
               'دوره ۲۰ ساعته مهارت کلیدی + تمرین عملی',
        impact:'اثر: متوسط',
        difficulty:'دشواری: کم',
        tip: decision==='startup' ? 'به معیار «درد/تکرار/بودجه» برای اولویت مشکل بچسب.' :
             decision==='career' ? '۳ شغل هدف = ۳ نمونه‌کار مطابق JD.' :
             'مرحله کوچک ولی پیوسته؛ بازخورد سریع بگیر.'
      });
      // 90 days
      acts.push({
        horizon:'۹۰ روزه',
        title: decision==='career' ? 'گواهی معتبر + ۲ پروژه متن‌باز/مشترک' :
               decision==='startup' ? 'MVP واقعی + ۳۰ کاربر آزمایشی' :
               decision==='invest' ? 'ریسک‌سنجی پرتفوی + سقف زیان تعریف‌شده' :
               decision==='relocate' ? 'سفر اکتشافی/رویداد شبکه‌سازی محلی' :
               'پروژه capstone با مربی/منتور',
        impact:'اثر: بالا',
        difficulty:'دشواری: متوسط',
        tip:'به یک شاخص موفقیت واحد متعهد شو و هر هفته اندازه‌گیری کن.'
      });
      // 180 days
      acts.push({
        horizon:'۱۸۰ روزه',
        title: decision==='career' ? 'جایگذاری در نقش هدف/ارتقا نقش فعلی' :
               decision==='startup' ? 'درآمد ماهانه تکرارشونده + چرخه ساخت/اندازه‌گیری' :
               decision==='invest' ? 'تنوع‌بخشی هوشمند + پوشش‌ریسک حداقلی' :
               decision==='relocate' ? 'جابجایی با برنامه مالی/اجتماعی' :
               'ارائه عمومی پروژه + شبکه حامیان',
        impact:'اثر: بسیار بالا',
        difficulty:'دشواری: متوسط/بالا',
        tip: riskTol==='high' ? 'آزمایش‌های ریسک‌پذیر را با سقف زیان مشخص انجام بده.' : 'تاب‌آوری را با ذخیره زمانی/مالی تقویت کن.'
      });

      actionsEl.innerHTML = '';
      acts.forEach(a=>{
        const card = document.createElement('div'); card.className='actionCard';
        card.innerHTML = `
          <div class="pill"><span style="width:8px; height:8px; background:#7aa2f7; border-radius:50%"></span>${a.horizon}</div>
          <div style="font-weight:700">${a.title}</div>
          <div class="muted" style="font-size:13px">${a.tip}</div>
          <div class="foot">
            <span class="pill impact">⚡ ${a.impact}</span>
            <span class="pill difficulty">🧩 ${a.difficulty}</span>
          </div>
        `;
        actionsEl.appendChild(card);
      });
    }

    function recompute(){ computeScores(); }
    decisionEl.onchange = recompute;
    riskEl.onchange = recompute;
    horizonEl.onchange = recompute;
    skillsEl.oninput = ()=>{ // debounce light
      clearTimeout(skillsEl._t); skillsEl._t = setTimeout(recompute, 300);
    }

    recompute();

    // ---------------------------
    // Save / Export / Theme
    // ---------------------------
    const saveBtn = document.getElementById('saveBtn');
    const exportBtn = document.getElementById('exportBtn');
    const themeToggle = document.getElementById('themeToggle');

    // load theme
    const savedTheme = localStorage.getItem('afx_theme');
    if(savedTheme==='light'){ document.body.classList.add('light'); themeToggle.checked = true; }

    themeToggle.addEventListener('change', ()=>{
      document.body.classList.toggle('light', themeToggle.checked);
      localStorage.setItem('afx_theme', themeToggle.checked? 'light':'dark');
    });

    saveBtn.addEventListener('click', ()=>{
      const payload = {
        decision: decisionEl.value,
        risk: riskEl.value,
        horizon: horizonEl.value,
        skills: skillsEl.value,
        trends: Array.from(selectedTrends),
        timestamp: Date.now()
      };
      localStorage.setItem('afx_lastScenario', JSON.stringify(payload));
      saveBtn.textContent = 'ذخیره شد ✓';
      setTimeout(()=> saveBtn.textContent = 'ذخیره سناریو', 1500);
    });

    exportBtn.addEventListener('click', ()=>{
      alert('خروجی PDF در گام بعدی فعال می‌شود. در حال حاضر می‌توانید با Print به PDF خروجی بگیرید.');
    });

    // restore last scenario if exists
    const last = localStorage.getItem('afx_lastScenario');
    if(last){
      try{
        const p = JSON.parse(last);
        decisionEl.value = p.decision || decisionEl.value;
        riskEl.value = p.risk || riskEl.value;
        horizonEl.value = p.horizon || horizonEl.value;
        skillsEl.value = p.skills || '';
        selectedTrends.clear(); (p.trends || []).forEach(t=>selectedTrends.add(t));
        renderTrendChips(); recompute();
      }catch(e){}
    }
  </script>
</body>
</html>
