<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>آینه آینده X — نسخه پیشرفته</title>
  <style>
    :root{
      --bg:#0b0f14; --bg2:#0f1520; --glass:rgba(255,255,255,0.06);
      --text:#e9efff; --muted:#9fb0cc; --accent:#7ee787; --accent2:#7aa2f7; --warn:#ffb86b; --risk:#ff6b6b;
      --chip:#1c2433; --chipText:#cfe3ff; --card:#0f1722; --border:rgba(255,255,255,0.12);
      --good:#27c498; --neutral:#b5c2d9; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: IRANSans, Segoe UI, Roboto, sans-serif;
      color:var(--text); background: radial-gradient(1200px 600px at 70% -10%, #162033, #0b0f14 60%) fixed;
      overflow-x:hidden;
    }
    #bgCanvas{position:fixed; inset:0; z-index:-1}

    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 20px; position:sticky; top:0; background:linear-gradient(180deg, rgba(11,15,20,0.9), rgba(11,15,20,0.6) 60%, transparent);
      backdrop-filter: blur(6px); border-bottom:1px solid var(--border); z-index:10;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:32px;height:32px;border-radius:10px; background:
      radial-gradient(80% 80% at 30% 30%, #7ee78744, transparent 70%),
      linear-gradient(135deg, #24344a, #141c29);
      border:1px solid var(--border); box-shadow:0 0 30px #7ee78722 inset, 0 0 12px #7ee78722;
    }
    h1{font-size:18px; margin:0}
    .header-actions{display:flex; gap:8px; align-items:center}
    .btn{padding:9px 12px; border:1px solid var(--border); border-radius:10px; color:var(--text);
      background: linear-gradient(180deg, #172033, #121a28); cursor:pointer; transition: all .2s ease; font-size:14px}
    .btn:hover{transform:translateY(-1px); box-shadow:0 6px 20px rgba(0,0,0,0.25)}
    .btn.primary{border-color:#2a7b5f; background:linear-gradient(180deg, #1a3b34, #112822); color:#aef7d3}
    .toggle{display:inline-flex; align-items:center; gap:6px; font-size:13px; color:#cfe3ff; cursor:pointer}
    .toggle input{accent-color:#7ee787; width:18px; height:18px}

    .container{max-width:1240px; margin:14px auto 60px; padding:0 16px}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:14px}
    @media (max-width: 1020px){ .grid{grid-template-columns: 1fr} }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border:1px solid var(--border); border-radius:16px; padding:12px 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .panel h2{font-size:16px; margin:0 0 8px 0; color:#cfe3ff}
    .panel p{color:var(--muted); margin:6px 0 10px 0; line-height:1.7}
    .field{margin:8px 0}
    .field label{display:block; color:#cfe3ff; font-size:13px; margin-bottom:6px}
    .input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#0e1420; color:var(--text); outline:none; transition:border .2s ease; font-size:14px;
    }
    textarea{min-height:84px; resize:vertical}
    .row{display:flex; gap:10px}
    .row .col{flex:1}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      border:1px solid var(--border); background:var(--chip); color:var(--chipText);
      font-size:12px; padding:6px 10px; border-radius:999px; display:inline-flex; align-items:center; gap:6px
    }
    .chip .dot{width:7px; height:7px; border-radius:999px; background:var(--accent); box-shadow:0 0 10px var(--accent)}

    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .card{flex:1 1 160px; background:linear-gradient(180deg, #0e1420, #0b1018); border:1px solid var(--border); border-radius:14px; padding:10px}
    .kpi .title{font-size:12px; color:#b7c7e8; margin-bottom:6px}
    .kpi .value{font-size:22px; font-weight:700}
    .kpi .trend{font-size:12px}
    .good{color:var(--good)} .bad{color:var(--bad)} .neutral{color:var(--neutral)}

    .viz{display:grid; grid-template-columns: 1.2fr 1fr; gap:12px}
    @media (max-width: 1020px){ .viz{grid-template-columns: 1fr} }
    .canvasWrap{position:relative; background:linear-gradient(180deg, rgba(15,21,32,0.8), rgba(10,14,22,0.6)); border:1px solid var(--border); border-radius:14px; padding:8px}
    #radar{width:100%; height:360px}
    .legend{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px}
    .legend .chip{background:#0e1726}

    .why{background: linear-gradient(180deg, #0e1522, #0c111b); border:1px solid var(--border); border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:8px; max-height:400px; overflow:auto}
    .why h3{margin:0 0 2px 0; font-size:14px; color:#cfe3ff}
    .why .reason{display:flex; align-items:flex-start; gap:10px; border-bottom:1px dashed var(--border); padding-bottom:8px}
    .why .reason:last-child{border-bottom:none}
    .bar{height:6px; background:#122036; border-radius:8px; overflow:hidden}
    .bar > span{display:block; height:100%; background: linear-gradient(90deg, #7ee787, #7aa2f7)}
    .why .srcs{display:flex; flex-wrap:wrap; gap:8px}
    .why .srcs .chip{background:#101a2b}

    .timeline{background:linear-gradient(180deg, #0e1522, #0c111b); border:1px solid var(--border); border-radius:14px; padding:10px}
    .timeline svg{width:100%; height:140px}
    .tick text{fill:#a9bfde; font-size:12px}

    .actions{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    @media (max-width: 900px){ .actions{grid-template-columns:1fr} }
    .actionCard{background:linear-gradient(180deg, #0f1726, #0c131f); border:1px solid var(--border); border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:6px}
    .pill{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:#bcd2f0; display:inline-flex; gap:6px; align-items:center}
    .impact{color:#aef7d3} .difficulty{color:#ffd28b}
    .foot{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:4px}

    .alerts{display:flex; flex-direction:column; gap:8px}
    .alert{border:1px solid var(--border); border-left:4px solid var(--warn); background:rgba(255,184,107,0.06); padding:8px 10px; border-radius:12px}
    .alert.danger{border-left-color: var(--risk); background: rgba(255,107,107,0.08)}
    .alert.ok{border-left-color: var(--good); background: rgba(39,196,152,0.08)}

    .matrix{margin-top:8px; border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .matrix table{width:100%; border-collapse:collapse; font-size:12px}
    .matrix th, .matrix td{padding:8px 10px; border-bottom:1px solid var(--border)}
    .matrix th{background:#0f1624; color:#cfe3ff; position:sticky; top:0}
    .matrix tr:last-child td{border-bottom:none}

    footer{margin:24px 0 50px; color:#89a1c5; font-size:12px; text-align:center}

    body.light{
      --bg:#f7fbff; --bg2:#eef5ff; --glass:rgba(0,0,0,0.05); --text:#0d1b2a; --muted:#3f5877;
      --chip:#e7eefc; --chipText:#0d1b2a; --card:#f0f6ff; --border:rgba(0,0,0,0.12);
      --accent:#0ea5a5; --accent2:#2563eb; --warn:#f59e0b; --risk:#ef4444;
      --good:#059669; --neutral:#64748b; --bad:#ef4444;
      background: radial-gradient(1200px 600px at 70% -10%, #e6f1ff, #f7fbff 60%) fixed;
    }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>

  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>آینه آینده X — نسخه پیشرفته</h1>
        <div class="muted" style="font-size:12px">سناریوساز شخصی با وزن‌دهی اندیشکده‌ها، هشدار ریسک و اقدامات عملی</div>
      </div>
    </div>
    <div class="header-actions">
      <button id="saveBtn" class="btn">ذخیره سناریو</button>
      <button id="exportBtn" class="btn">چاپ/PDF</button>
      <label class="toggle">
        <input id="themeToggle" type="checkbox"/> حالت روشن
      </label>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Left: Inputs -->
      <div class="panel">
        <h2>پروفایل، تصمیم و منابع</h2>
        <div class="field">
          <label>هدف تصمیم</label>
          <select id="decision">
            <option value="career">تغییر مسیر شغلی</option>
            <option value="startup">راه‌اندازی استارتاپ</option>
            <option value="invest">سرمایه‌گذاری شخصی</option>
            <option value="relocate">جابجایی/مهاجرت</option>
            <option value="learn">یادگیری مهارت جدید</option>
          </select>
        </div>
        <div class="row">
          <div class="col field">
            <label>تحمل ریسک</label>
            <select id="risk">
              <option value="low">پایین</option>
              <option value="mid" selected>متوسط</option>
              <option value="high">بالا</option>
            </select>
          </div>
          <div class="col field">
            <label>افق زمانی</label>
            <select id="horizon">
              <option value="6">۶ ماه</option>
              <option value="12" selected>۱۲ ماه</option>
              <option value="24">۲۴ ماه</option>
              <option value="36">۳۶ ماه</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>ترندهای مدنظر</label>
          <div id="trendChips" class="chips"></div>
          <div class="muted" style="font-size:12px">روشن/خاموش کن و اثرش را بر ریسک/فرصت ببین.</div>
        </div>

        <div class="field">
          <label>مهارت‌ها یا رزومه متنی/لینک‌ها</label>
          <textarea id="profileText" placeholder="نمونه: AI, Data, Python, انرژی پاک، لینک گیت‌هاب/لینکدین، خلاصه رزومه..."></textarea>
          <div class="row">
            <button id="analyzeBtn" class="btn">تحلیل مهارت</button>
            <div id="skillNote" class="muted" style="padding:8px 0 0 6px; font-size:12px">تحلیل محلی و سریع</div>
          </div>
        </div>

        <div class="section">
          <h2>اندیشکده‌ها و وزن‌دهی</h2>
          <p class="muted">وزن‌ها بر اساس تناسب با تصمیم/ترندها تنظیم می‌شود. می‌توانی دستی هم تغییر بدهی.</p>
          <div id="sourceChips" class="chips"></div>
          <div class="matrix" style="margin-top:10px">
            <table id="matrixTable">
              <thead>
                <tr>
                  <th>دامنه</th>
                  <th>وزن پایه</th>
                  <th>وزن پویا</th>
                  <th>توضیح کوتاه</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="section">
          <h2>آستانه هشدارها</h2>
          <div class="row">
            <div class="col field">
              <label>آستانه ریسک سیستمی</label>
              <input id="thrRisk" class="input" type="number" min="0" max="1" step="0.01" value="0.6"/>
            </div>
            <div class="col field">
              <label>آستانه عدم‌قطعیت</label>
              <input id="thrUnc" class="input" type="number" min="0" max="1" step="0.01" value="0.7"/>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Outputs -->
      <div class="panel">
        <h2>خلاصه سناریو</h2>
        <div class="kpi">
          <div class="card">
            <div class="title">شاخص فرصت</div>
            <div id="oppVal" class="value">—</div>
            <div id="oppTrend" class="trend good">—</div>
          </div>
          <div class="card">
            <div class="title">ریسک سیستمی</div>
            <div id="riskVal" class="value">—</div>
            <div id="riskNote" class="trend bad">—</div>
          </div>
          <div class="card">
            <div class="title">عدم‌قطعیت</div>
            <div id="uncVal" class="value">—</div>
            <div class="trend neutral">هرچه بالاتر، بازه پیش‌بینی پهن‌تر</div>
          </div>
        </div>

        <div class="section alerts">
          <div id="alertsBox"></div>
        </div>

        <div class="section viz">
          <div class="canvasWrap">
            <canvas id="radar"></canvas>
            <div class="legend">
              <span class="chip"><span class="dot"></span> امتیاز</span>
              <span class="chip" style="--accent:#ffd28b"><span class="dot" style="background:#ffd28b; box-shadow:0 0 10px #ffd28b"></span> باند عدم‌قطعیت</span>
            </div>
          </div>
          <div class="why">
            <h3>چرا این نتیجه؟</h3>
            <div id="whyList"></div>
            <div>
              <div class="muted" style="margin:4px 0 6px">منابع مؤثر:</div>
              <div class="srcs" id="whySources"></div>
            </div>
          </div>
        </div>

        <div class="section timeline">
          <h2>نقشه زمان 2025–2032</h2>
          <svg id="timelineSvg" viewBox="0 0 900 140" preserveAspectRatio="xMidYMid meet"></svg>
        </div>

        <div class="section">
          <h2>سناریوهای نامتقارن</h2>
          <div id="scenarios" class="actions"></div>
        </div>

        <div class="section">
          <h2>گام‌های پیشنهادی</h2>
          <div id="actions" class="actions"></div>
        </div>

        <div class="section">
          <h2>ماتریس وزن‌دهی منابع</h2>
          <div class="matrix">
            <table id="sourceTable">
              <thead>
                <tr>
                  <th>اندیشکده</th>
                  <th>دامنه غالب</th>
                  <th>وزن</th>
                  <th>اثر بر تصمیم</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer>
      نسخه پیشرفته نمایشی. آماده اتصال به داده‌های زنده، API پروفایل و مدل‌های وزن‌دهی دقیق‌تر.
    </footer>
  </div>

  <script>
    // ---------------------------
    // Background stars
    // ---------------------------
    const bg = document.getElementById('bgCanvas');
    const bctx = bg.getContext('2d');
    const dpi = window.devicePixelRatio || 1;
    let stars = [];
    function resizeBg(){
      bg.width = innerWidth * dpi; bg.height = innerHeight * dpi;
      bctx.setTransform(dpi,0,0,dpi,0,0);
      stars = Array.from({length: 180}, ()=>({
        x: Math.random()*innerWidth, y: Math.random()*innerHeight, z: Math.random()*1.2 + 0.2, s: Math.random()*1.5 + 0.3
      }));
    }
    function tickBg(){
      bctx.clearRect(0,0,innerWidth,innerHeight);
      stars.forEach(st=>{
        st.y += st.z*0.15; if(st.y>innerHeight) { st.y=-5; st.x=Math.random()*innerWidth; }
        bctx.fillStyle = `rgba(${180 + st.z*50}, ${210}, 255, ${0.35+st.z*0.4})`;
        bctx.beginPath(); bctx.arc(st.x, st.y, st.s, 0, Math.PI*2); bctx.fill();
      });
      requestAnimationFrame(tickBg);
    }
    resizeBg(); requestAnimationFrame(tickBg);
    addEventListener('resize', resizeBg);

    // ---------------------------
    // Data: Domains, Trends, Sources
    // ---------------------------
    const DOMAINS = [
      { id:'econ', label:'اقتصاد و بازار' },
      { id:'geo', label:'ژئوپلیتیک و امنیت' },
      { id:'tech', label:'فناوری و نوآوری' },
      { id:'clim', label:'اقلیم و پایداری' },
      { id:'soc',  label:'جامعه و کار' },
    ];

    const TRENDS = [
      { id:'ai', name:'هوش مصنوعی مولد', risk:0.2, opp:0.35, unc:0.15, domain:'tech' },
      { id:'green', name:'گذار سبز و کربن‌صفر', risk:0.18, opp:0.28, unc:0.14, domain:'clim' },
      { id:'geo', name:'ریسک ژئوپلیتیک', risk:0.35, opp:-0.05, unc:0.22, domain:'geo' },
      { id:'supply', name:'بازآرایی زنجیره تأمین', risk:0.22, opp:0.18, unc:0.12, domain:'econ' },
      { id:'aging', name:'سالمندی جمعیت', risk:0.25, opp:0.05, unc:0.10, domain:'soc' },
      { id:'bio', name:'همگرایی بیو/دیجیتال', risk:0.15, opp:0.22, unc:0.12, domain:'tech' },
      { id:'cyber', name:'امنیت سایبری', risk:0.20, opp:0.12, unc:0.12, domain:'geo' },
      { id:'energy', name:'انرژی‌های نو', risk:0.17, opp:0.25, unc:0.12, domain:'clim' },
      { id:'urban', name:'شهرهای هوشمند', risk:0.12, opp:0.14, unc:0.08, domain:'tech' },
      { id:'fin', name:'فین‌تک/دارایی‌های دیجیتال', risk:0.22, opp:0.16, unc:0.15, domain:'econ' },
    ];

    // 30+ sources mapped to domains with base weights (0..1)
    const SOURCES = [
      { name:'European Commission JRC Strategic Foresight', domain:'econ', w:0.8 },
      { name:'OECD Strategic Foresight', domain:'econ', w:0.8 },
      { name:'World Economic Forum', domain:'econ', w:0.7 },
      { name:'Brookings Institution', domain:'econ', w:0.7 },
      { name:'RAND Corporation', domain:'geo', w:0.8 },
      { name:'Chatham House (RIIA)', domain:'geo', w:0.8 },
      { name:'CSIS', domain:'geo', w:0.85 },
      { name:'Carnegie Endowment for International Peace', domain:'geo', w:0.75 },
      { name:'Atlantic Council', domain:'geo', w:0.75 },
      { name:'Council on Foreign Relations (CFR)', domain:'geo', w:0.7 },
      { name:'Peterson Institute for International Economics (PIIE)', domain:'econ', w:0.75 },
      { name:'Bruegel', domain:'econ', w:0.8 },
      { name:'CEPS', domain:'econ', w:0.7 },
      { name:'SWP (German Institute for Int. and Security Affairs)', domain:'geo', w:0.8 },
      { name:'Bertelsmann Stiftung', domain:'soc', w:0.65 },
      { name:'Kiel Institute (IfW Kiel)', domain:'econ', w:0.7 },
      { name:'DIW Berlin', domain:'econ', w:0.7 },
      { name:'Clingendael Institute', domain:'geo', w:0.7 },
      { name:'IFRI', domain:'geo', w:0.7 },
      { name:'IISS', domain:'geo', w:0.75 },
      { name:'SIPRI', domain:'geo', w:0.75 },
      { name:'GMF (German Marshall Fund)', domain:'geo', w:0.7 },
      { name:'MERICS', domain:'geo', w:0.7 },
      { name:'Lowy Institute', domain:'geo', w:0.7 },
      { name:'ASPI', domain:'geo', w:0.7 },
      { name:'NBR', domain:'geo', w:0.7 },
      { name:'Hoover Institution', domain:'econ', w:0.6 },
      { name:'AEI', domain:'econ', w:0.6 },
      { name:'Cato Institute', domain:'econ', w:0.6 },
      { name:'Heritage Foundation', domain:'econ', w:0.6 },
      { name:'Urban Institute', domain:'soc', w:0.6 },
      { name:'Nesta', domain:'tech', w:0.7 },
      { name:'Demos', domain:'soc', w:0.6 },
      { name:'Institute for the Future (IFTF)', domain:'tech', w:0.75 },
      { name:'Oxford Martin School', domain:'tech', w:0.75 },
      { name:'Fraunhofer ISI', domain:'tech', w:0.8 },
      { name:'Copenhagen Institute for Futures Studies (CIFS)', domain:'tech', w:0.75 },
      { name:'McKinsey Global Institute (MGI)', domain:'econ', w:0.8 },
      { name:'EPRS (European Parliamentary Research Service)', domain:'econ', w:0.7 },
      { name:'Carnegie Europe', domain:'geo', w:0.7 },
    ];

    // ---------------------------
    // UI elements
    // ---------------------------
    const trendChips = document.getElementById('trendChips');
    const sourceChips = document.getElementById('sourceChips');
    const matrixTableBody = document.querySelector('#matrixTable tbody');
    const sourceTableBody = document.querySelector('#sourceTable tbody');

    const decisionEl = document.getElementById('decision');
    const riskEl = document.getElementById('risk');
    const horizonEl = document.getElementById('horizon');
    const profileText = document.getElementById('profileText');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const skillNote = document.getElementById('skillNote');

    const oppVal = document.getElementById('oppVal');
    const oppTrend = document.getElementById('oppTrend');
    const riskVal = document.getElementById('riskVal');
    const riskNote = document.getElementById('riskNote');
    const uncVal = document.getElementById('uncVal');
    const alertsBox = document.getElementById('alertsBox');

    const whyList = document.getElementById('whyList');
    const whySources = document.getElementById('whySources');

    const actionsEl = document.getElementById('actions');
    const scenariosEl = document.getElementById('scenarios');

    const thrRiskEl = document.getElementById('thrRisk');
    const thrUncEl = document.getElementById('thrUnc');

    // trend selection
    const selectedTrends = new Set(['ai','green','geo','supply']);

    function renderTrendChips(){
      trendChips.innerHTML = '';
      TRENDS.forEach(t=>{
        const on = selectedTrends.has(t.id);
        const el = document.createElement('span');
        el.className = 'chip';
        el.style.borderColor = on ? '#2a7b5f' : 'var(--border)';
        el.style.boxShadow = on ? '0 0 18px rgba(126,231,135,0.15) inset' : 'none';
        el.style.cursor = 'pointer';
        el.innerHTML = `<span class="dot" style="background:${on?'#7ee787':'#6b7280'}; box-shadow:0 0 10px ${on?'#7ee787':'#6b728033'}"></span>${t.name}`;
        el.onclick = ()=>{ if(on) selectedTrends.delete(t.id); else selectedTrends.add(t.id); renderTrendChips(); recompute(); };
        trendChips.appendChild(el);
      });
    }

    function renderSourceChips(){
      sourceChips.innerHTML = '';
      SOURCES.forEach((s,i)=>{
        const el = document.createElement('span');
        el.className = 'chip';
        el.title = s.name;
        const clr = s.domain==='econ'?'#7ee787': s.domain==='geo'?'#ffb4b4': s.domain==='tech'?'#7aa2f7': s.domain==='clim'?'#ffd28b':'#c0a6ff';
        el.innerHTML = `<span class="dot" style="background:${clr}"></span>${s.name}`;
        sourceChips.appendChild(el);
      });
    }

    renderTrendChips();
    renderSourceChips();

    // ---------------------------
    // Radar
    // ---------------------------
    const radar = document.getElementById('radar');
    const rctx = radar.getContext('2d');
    function resizeRadar(){
      const rect = radar.getBoundingClientRect();
      radar.width = rect.width * dpi;
      radar.height = rect.height * dpi;
      rctx.setTransform(dpi,0,0,dpi,0,0);
      drawRadar();
    }
    addEventListener('resize', resizeRadar);

    const DIMENSIONS = [
      { id:'career', label:'شغل و مهارت' },
      { id:'wealth', label:'سرمایه و ثروت' },
      { id:'well', label:'رفاه و سلامت' },
      { id:'impact', label:'پایداری و اثر' },
      { id:'res', label:'تاب‌آوری' },
    ];
    let scores = { career:0.6, wealth:0.55, well:0.58, impact:0.62, res:0.57 };
    let bands  = { career:0.12, wealth:0.1, well:0.11, impact:0.09, res:0.1 };

    function drawRadar(){
      const w = radar.width/dpi, h = radar.height/dpi;
      rctx.clearRect(0,0,w,h);
      const cx = w/2, cy = h/2 + 8;
      const radius = Math.min(w,h)*0.36;

      rctx.save();
      rctx.strokeStyle = 'rgba(180,200,240,0.25)';
      rctx.lineWidth = 1;
      for(let g=1; g<=4; g++){
        rctx.beginPath();
        const r = radius * (g/4);
        for(let i=0;i<DIMENSIONS.length;i++){
          const a = (Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
          const x = cx + r*Math.cos(a), y = cy + r*Math.sin(a);
          i===0 ? rctx.moveTo(x,y) : rctx.lineTo(x,y);
        }
        rctx.closePath(); rctx.stroke();
      }
      DIMENSIONS.forEach((d,i)=>{
        const a = (Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
        const x = cx + radius*Math.cos(a), y = cy + radius*Math.sin(a);
        rctx.beginPath(); rctx.moveTo(cx,cy); rctx.lineTo(x,y); rctx.strokeStyle='rgba(180,200,240,0.15)'; rctx.stroke();
        const lx = cx + (radius+18)*Math.cos(a), ly = cy + (radius+18)*Math.sin(a);
        rctx.fillStyle = '#cfe3ff'; rctx.font = '12px sans-serif'; rctx.textAlign = Math.cos(a)>0.2? 'left' : (Math.cos(a)<-0.2? 'right':'center');
        rctx.fillText(d.label, lx, ly);
      });

      // Uncertainty band
      rctx.beginPath();
      DIMENSIONS.forEach((d,i)=>{
        const a = (Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
        const r = radius * Math.min(1, Math.max(0, scores[d.id] + bands[d.id]));
        const x = cx + r*Math.cos(a), y = cy + r*Math.sin(a);
        i===0 ? rctx.moveTo(x,y) : rctx.lineTo(x,y);
      });
      rctx.closePath();
      rctx.fillStyle = 'rgba(255,210,139,0.18)';
      rctx.fill();

      // Score polygon
      rctx.beginPath();
      DIMENSIONS.forEach((d,i)=>{
        const a = (Math.PI*2)*i/DIMENSIONS.length - Math.PI/2;
        const r = radius * Math.min(1, Math.max(0, scores[d.id]));
        const x = cx + r*Math.cos(a), y = cy + r*Math.sin(a);
        i===0 ? rctx.moveTo(x,y) : rctx.lineTo(x,y);
      });
      rctx.closePath();
      const grad = rctx.createLinearGradient(0,0,w,h);
      grad.addColorStop(0,'rgba(126,231,135,0.28)');
      grad.addColorStop(1,'rgba(122,162,247,0.28)');
      rctx.fillStyle = grad; rctx.fill();
      rctx.strokeStyle = 'rgba(126,231,135,0.7)';
      rctx.lineWidth = 2; rctx.stroke();

      rctx.restore();
    }
    resizeRadar();

    // ---------------------------
    // Timeline SVG
    // ---------------------------
    function renderTimeline(){
      const svg = document.getElementById('timelineSvg');
      const years = [2025,2026,2027,2028,2029,2030,2031,2032];
      const w = 900, h = 140, pad = 60;
      svg.innerHTML='';
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', pad); line.setAttribute('y1', h/2);
      line.setAttribute('x2', w-pad); line.setAttribute('y2', h/2);
      line.setAttribute('stroke', '#2b3a55'); line.setAttribute('stroke-width','2');
      svg.appendChild(line);

      years.forEach((y,i)=>{
        const x = pad + i*((w-2*pad)/(years.length-1));
        const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
        tick.setAttribute('x1', x); tick.setAttribute('y1', h/2 - 8);
        tick.setAttribute('x2', x); tick.setAttribute('y2', h/2 + 8);
        tick.setAttribute('stroke','#3b5177'); tick.setAttribute('stroke-width','2');
        svg.appendChild(tick);

        const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x', x); txt.setAttribute('y', h/2 + 28);
        txt.setAttribute('text-anchor','middle'); txt.setAttribute('class','tick');
        txt.textContent = y;
        svg.appendChild(txt);
      });

      const markers = [
        { y:2025, label:'MVP مهارت/پروتوتایپ', tone:'#7ee787' },
        { y:2026, label:'اعتبارسنجی بازار/شبکه', tone:'#7aa2f7' },
        { y:2027, label:'گسترش/تنوع‌بخشی', tone:'#ffd28b' },
        { y:2029, label:'تاب‌آوری/ریسک ژئو', tone:'#ffb4b4' },
        { y:2031, label:'استانداردسازی/ESG', tone:'#aef7d3' },
      ];
      markers.forEach(m=>{
        const i = years.indexOf(m.y); if(i<0) return;
        const x = pad + i*((w-2*pad)/(years.length-1));
        const cy = 56;
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', x); c.setAttribute('cy', cy); c.setAttribute('r','7');
        c.setAttribute('fill', m.tone); c.setAttribute('opacity','0.9');
        svg.appendChild(c);

        const lab = document.createElementNS('http://www.w3.org/2000/svg','text');
        lab.setAttribute('x', x); lab.setAttribute('y', cy - 12);
        lab.setAttribute('text-anchor','middle'); lab.setAttribute('class','tick');
        lab.textContent = m.label;
        svg.appendChild(lab);
      });
    }
    renderTimeline();

    // ---------------------------
    // Skills parsing (local heuristic)
    // ---------------------------
    const SKILL_MAP = [
      { keys:['ai','ml','machine learning','هوش','یادگیری','python','pytorch','tensorflow','data','داده'], dim:'career', delta:0.06, domain:'tech' },
      { keys:['climate','energy','esg','sustain','green','انرژی','اقلیم','پایداری'], dim:'impact', delta:0.05, domain:'clim' },
      { keys:['product','design','ux','ui','figma','طراحی','محصول'], dim:'career', delta:0.03, domain:'tech' },
      { keys:['security','امنیت','cyber','devsecops'], dim:'res', delta:0.05, domain:'geo' },
      { keys:['finance','quant','valuation','مالی','پرتفوی'], dim:'wealth', delta:0.05, domain:'econ' },
      { keys:['health','سلامت','bio','biology'], dim:'well', delta:0.03, domain:'soc' },
    ];

    function analyzeSkillsText(text){
      const t = (text||'').toLowerCase();
      const hits = [];
      SKILL_MAP.forEach(s=>{
        if(s.keys.some(k=>t.includes(k))){
          hits.push(s);
        }
      });
      return hits;
    }

    analyzeBtn.addEventListener('click', ()=>{
      const hits = analyzeSkillsText(profileText.value);
      if(hits.length===0){ skillNote.textContent = 'مهارت مشخصی پیدا نشد. چند کلیدواژه اضافه کن.'; }
      else{
        const labs = Array.from(new Set(hits.map(h=>h.keys[0])));
        skillNote.textContent = `مهارت‌های شناسایی‌شده: ${labs.slice(0,6).join(', ')} (+${hits.length - 6 > 0 ? (hits.length-6)+' بیشتر' : 0})`;
      }
      recompute();
    });

    // ---------------------------
    // Weighting Matrix: domains and sources
    // ---------------------------
    function baseByDecision(dec){
      switch(dec){
        case 'career': return { career:0.62, wealth:0.55, well:0.60, impact:0.58, res:0.57 };
        case 'startup': return { career:0.58, wealth:0.60, well:0.52, impact:0.64, res:0.55 };
        case 'invest': return { career:0.52, wealth:0.65, well:0.56, impact:0.50, res:0.58 };
        case 'relocate': return { career:0.60, wealth:0.56, well:0.62, impact:0.55, res:0.60 };
        case 'learn': return { career:0.66, wealth:0.54, well:0.60, impact:0.58, res:0.56 };
      }
      return { career:0.58, wealth:0.58, well:0.58, impact:0.58, res:0.58 };
    }

    function decisionDomainPrefs(dec){
      // preferred domain weights for the decision (sum ~ 1)
      switch(dec){
        case 'career': return { tech:0.32, econ:0.22, soc:0.18, geo:0.14, clim:0.14 };
        case 'startup': return { tech:0.30, econ:0.28, soc:0.12, geo:0.14, clim:0.16 };
        case 'invest': return { econ:0.36, geo:0.22, tech:0.20, clim:0.12, soc:0.10 };
        case 'relocate': return { soc:0.26, econ:0.22, geo:0.22, tech:0.16, clim:0.14 };
        case 'learn': return { tech:0.36, econ:0.18, soc:0.20, geo:0.12, clim:0.14 };
      }
      return { tech:0.28, econ:0.24, geo:0.18, clim:0.16, soc:0.14 };
    }

    function dynamicDomainWeights(dec, activeTrends){
      const base = decisionDomainPrefs(dec);
      const w = { tech:base.tech||0, econ:base.econ||0, geo:base.geo||0, clim:base.clim||0, soc:base.soc||0 };
      activeTrends.forEach(id=>{
        const t = TRENDS.find(x=>x.id===id); if(!t) return;
        w[t.domain] += 0.06; // emphasize domains aligned with active trends
      });
      // normalize to sum 1
      const sum = Object.values(w).reduce((a,b)=>a+b,0) || 1;
      for(const k in w) w[k] = w[k]/sum;
      return w;
    }

    function renderDomainMatrix(domainWeights){
      matrixTableBody.innerHTML = '';
      const notes = {
        econ:'رشد/تورم/بهره و بازارها',
        geo:'درگیری‌ها/وابستگی و امنیت',
        tech:'بهره‌وری/اتوماسیون و رقابت',
        clim:'مقررات/ESG و هزینه انرژی',
        soc:'جمعیت/مهارت و عدالت'
      };
      DOMAINS.forEach(d=>{
        const tr = document.createElement('tr');
        const base = decisionDomainPrefs(decisionEl.value)[d.id] || 0;
        const dyn = domainWeights[d.id] || 0;
        tr.innerHTML = `
          <td>${d.label}</td>
          <td>${(base).toFixed(2)}</td>
          <td>${(dyn).toFixed(2)}</td>
          <td>${notes[d.id]}</td>
        `;
        matrixTableBody.appendChild(tr);
      });
    }

    function renderSourceTable(domainWeights){
      sourceTableBody.innerHTML = '';
      SOURCES.forEach(s=>{
        // final weight = base weight * domain dynamic weight
        const dw = domainWeights[s.domain] || 0.2;
        const finalW = (s.w * (0.6 + 0.4*dw)); // compress to [~0.3..~1]
        const tr = document.createElement('tr');
        const domainLabel = DOMAINS.find(d=>d.id===s.domain)?.label || s.domain;
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${domainLabel}</td>
          <td>${finalW.toFixed(2)}</td>
          <td>${finalW>0.65? 'اثر قوی':'اثر متوسط'}</td>
        `;
        sourceTableBody.appendChild(tr);
      });
    }

    // ---------------------------
    // Scenario computation
    // ---------------------------
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function computeUncertainty(riskTolerance, horizon, trendSet){
      let u = 0.1 + (horizon/36)*0.12; // افق بلندتر => عدم قطعیت بیشتر
      if(riskTolerance==='low') u += 0.04;
      if(riskTolerance==='high') u -= 0.02;
      trendSet.forEach(id=>{
        const t = TRENDS.find(x=>x.id===id); if(!t) return;
        u += t.unc * 0.5 / (2 + trendSet.size*0.3);
      });
      return clamp01(u);
    }

    function computeScores(){
      const dec = decisionEl.value;
      const riskTol = riskEl.value;
      const horizon = Number(horizonEl.value);
      const activeTrends = Array.from(selectedTrends);

      // dynamic domain weights
      const domainW = dynamicDomainWeights(dec, selectedTrends);
      renderDomainMatrix(domainW);
      renderSourceTable(domainW);

      // baseline by decision
      scores = baseByDecision(dec);
      let opportunity = 0.58, systemicRisk = 0.38;

      // trend contributions modulated by domain weights
      activeTrends.forEach(id=>{
        const t = TRENDS.find(x=>x.id===id);
        const domFactor = (domainW[t.domain] || 0.2) + 0.6; // 0.6..1.6
        opportunity += t.opp * 0.36 * domFactor/(1 + activeTrends.length*0.25);
        systemicRisk += t.risk * 0.42 * domFactor/(1 + activeTrends.length*0.25);

        // distribute per dimensions
        scores.career += (t.opp - t.risk*0.12)*0.18*domFactor;
        scores.wealth += (t.opp - t.risk*0.10)*0.22*domFactor;
        scores.impact += (t.opp)*0.20*domFactor;
        scores.res += (0.10 - t.risk*0.16)*domFactor;
        scores.well += (0.06 - t.risk*0.05)*domFactor;
      });

      // skills effect
      const hits = analyzeSkillsText(profileText.value);
      hits.forEach(h=>{
        scores[h.dim] += h.delta;
        opportunity += h.delta*0.6;
      });

      // risk tolerance
      const riskScale = riskTol==='low'? -0.04 : (riskTol==='high'? +0.03 : 0);
      systemicRisk = clamp01(systemicRisk + riskScale);

      if(horizon<=6) opportunity -= 0.03;

      for(const k in scores) scores[k] = clamp01(scores[k]);
      const unc = computeUncertainty(riskTol, horizon, selectedTrends);

      const bandBase = unc*0.22;
      bands = {
        career: bandBase * 0.95,
        wealth: bandBase * 1.00,
        well:   bandBase * 0.9,
        impact: bandBase * 0.85,
        res:    bandBase * 0.95,
      };

      // KPIs
      oppVal.textContent = Math.round(clamp01(opportunity)*100) + '%';
      oppTrend.textContent = opportunity>0.6? 'صعود ملایم' : (opportunity>0.5? 'خنثی' : 'نیاز به بهبود');
      oppTrend.className = 'trend ' + (opportunity>0.6? 'good' : (opportunity>0.5?'neutral':'bad'));
      riskVal.textContent = Math.round(systemicRisk*100) + '%';
      riskNote.textContent = systemicRisk>0.55? 'ریسک بالاتر از حد نرمال' : (systemicRisk<0.35? 'ریسک کنترل‌شده' : 'ریسک متوسط');
      riskNote.className = 'trend ' + (systemicRisk>0.55? 'bad' : (systemicRisk<0.35? 'good':'neutral'));
      uncVal.textContent = Math.round(unc*100) + '%';

      drawRadar();
      renderWhy(dec, riskTol, horizon, unc, domainW);
      renderActions(dec, riskTol, horizon);
      renderScenarios(dec, systemicRisk, opportunity, unc, domainW);
      renderAlerts(systemicRisk, unc, activeTrends);
    }

    function renderWhy(dec, riskTol, horizon, unc, domainW){
      const reasons = [
        { title:'وزن‌دهی دامنه‌ها', detail:`وزن پویا: Tech ${domainW.tech?.toFixed(2)||0}, Econ ${domainW.econ?.toFixed(2)||0}, Geo ${domainW.geo?.toFixed(2)||0}, Clim ${domainW.clim?.toFixed(2)||0}, Soc ${domainW.soc?.toFixed(2)||0}`, weight:0.30 },
        { title:'اثر ترندهای فعال', detail:`ترکیب ترندها فرصت/ریسک را تغییر داده است. عدم‌قطعیت فعلی: ${Math.round(unc*100)}%`, weight:0.26 },
        { title:'تناسب تصمیم با مهارت‌ها', detail:'مهارت‌های شناسایی‌شده به ابعاد امتیاز نگاشت شده‌اند.', weight:0.20 },
        { title:'افق زمانی', detail:`افق ${horizon} ماهه دامنه باند عدم‌قطعیت را تغییر داده است.`, weight:0.14 },
        { title:'تحمل ریسک', detail:`تنظیم ${riskTol==='low'?'محافظه‌کارانه':(riskTol==='high'?'تهاجمی':'متعادل')} در وزن‌دهی لحاظ شد.`, weight:0.10 },
      ];
      whyList.innerHTML = '';
      reasons.forEach(r=>{
        const row = document.createElement('div');
        row.className = 'reason';
        row.innerHTML = `
          <div style="min-width:8px; height:8px; background:#7ee787; border-radius:50%; margin-top:6px"></div>
          <div style="flex:1">
            <div style="color:#cfe3ff; font-size:13px; margin-bottom:4px">${r.title}</div>
            <div class="muted" style="font-size:12px; margin-bottom:8px">${r.detail}</div>
            <div class="bar"><span style="width:${Math.round(r.weight*100)}%"></span></div>
          </div>
        `;
        whyList.appendChild(row);
      });

      // show 16 relevant sources emphasizing domains with higher weights
      whySources.innerHTML = '';
      const sortedDomains = Object.entries(domainW).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);
      const pool = SOURCES.slice().sort((a,b)=>{
        const da = sortedDomains.indexOf(a.domain), db = sortedDomains.indexOf(b.domain);
        return da - db;
      });
      pool.slice(0,16).forEach((s,i)=>{
        const clr = s.domain==='econ'?'#7ee787': s.domain==='geo'?'#ffb4b4': s.domain==='tech'?'#7aa2f7': s.domain==='clim'?'#ffd28b':'#c0a6ff';
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span class="dot" style="background:${clr}"></span>${s.name}`;
        whySources.appendChild(chip);
      });
    }

    function renderAlerts(systemicRisk, unc, activeTrends){
      alertsBox.innerHTML = '';
      const thrR = parseFloat(thrRiskEl.value)||0.6;
      const thrU = parseFloat(thrUncEl.value)||0.7;

      if(systemicRisk >= thrR){
        const el = document.createElement('div');
        el.className = 'alert danger';
        el.innerHTML = `<strong>هشدار:</strong> ریسک سیستمی بالاتر از آستانه است. پوشش‌ریسک و سناریوهای محافظه‌کار را فعال کن.`;
        alertsBox.appendChild(el);
      }
      if(unc >= thrU){
        const el = document.createElement('div');
        el.className = 'alert';
        el.innerHTML = `<strong>تذکر:</strong> عدم‌قطعیت زیاد است؛ تصمیم‌های قابل برگشت و آزمایش‌های کوچک ارزشمندترند.`;
        alertsBox.appendChild(el);
      }
      // combo-based alerts
      const ids = new Set(activeTrends);
      if(ids.has('geo') && ids.has('energy')){
        const el = document.createElement('div');
        el.className = 'alert';
        el.innerHTML = `<strong>هشدار ترکیبی:</strong> ژئوپلیتیک + انرژی‌های نو می‌تواند نوسان قیمت/زیرساخت ایجاد کند. برنامه انعطاف‌پذیری تهیه کن.`;
        alertsBox.appendChild(el);
      }
      if(ids.has('ai') && ids.has('cyber')){
        const el = document.createElement('div');
        el.className = 'alert';
        el.innerHTML = `<strong>هشدار امنیت:</strong> اتوماسیون + آسیب‌پذیری‌های سایبری. به کنترل دسترسی و ممیزی داده توجه کن.`;
        alertsBox.appendChild(el);
      }
      if(alertsBox.children.length===0){
        const el = document.createElement('div');
        el.className = 'alert ok';
        el.innerHTML = `<strong>وضعیت پایدار:</strong> هشدار فعال وجود ندارد. با این حال، پایش مستمر ادامه یابد.`;
        alertsBox.appendChild(el);
      }
    }

    function renderActions(decision, riskTol, horizon){
      const acts = [];
      acts.push({
        horizon:'۳۰ روزه',
        title: decision==='career' ? 'نمونه‌کار هدفمند + ۳ گفت‌وگوی اطلاعاتی' :
               decision==='startup' ? 'مصاحبه ۱۰ مشتری + MVP کاغذی' :
               decision==='invest' ? 'IPS یک‌صفحه‌ای + معیارهای ریسک' :
               decision==='relocate' ? 'تحلیل ۳ شهر با ماتریس امتیازدهی' :
               'دوره ۲۰ ساعته مهارت کلیدی + تمرین',
        impact:'اثر: متوسط',
        difficulty:'دشواری: کم',
        tip: decision==='startup' ? 'معیار درد/تکرار/بودجه را برای اولویت مشکل بسنج.' :
             decision==='career' ? '۳ شغل هدف = ۳ نمونه‌کار مطابق JD.' : 'بازخورد سریع بگیر و مسیر را اصلاح کن.'
      });
      acts.push({
        horizon:'۹۰ روزه',
        title: decision==='career' ? 'گواهی معتبر + ۲ پروژه مشترک/متن‌باز' :
               decision==='startup' ? 'MVP واقعی + ۳۰ کاربر آزمایشی' :
               decision==='invest' ? 'تنوع‌بخشی + سقف زیان تعریف‌شده' :
               decision==='relocate' ? 'سفر اکتشافی + رویداد شبکه محلی' :
               'پروژه capstone با منتور',
        impact:'اثر: بالا',
        difficulty:'دشواری: متوسط',
        tip:'یک شاخص موفقیت واحد انتخاب کن و هفتگی پایش کن.'
      });
      acts.push({
        horizon:'۱۸۰ روزه',
        title: decision==='career' ? 'جایگذاری در نقش هدف/ارتقا' :
               decision==='startup' ? 'MRR با چرخه ساخت/اندازه‌گیری' :
               decision==='invest' ? 'پوشش‌ریسک حداقلی + بازمتوازن‌سازی' :
               decision==='relocate' ? 'جابجایی با برنامه مالی/اجتماعی' :
               'ارائه عمومی + شبکه حامیان',
        impact:'اثر: بسیار بالا',
        difficulty:'دشواری: متوسط/بالا',
        tip: riskTol==='high' ? 'آزمایش‌های آپساید را با سقف زیان مشخص امتحان کن.' : 'ذخیره زمانی/مالی برای تاب‌آوری نگه‌دار.'
      });

      actionsEl.innerHTML = '';
      acts.forEach(a=>{
        const card = document.createElement('div'); card.className='actionCard';
        card.innerHTML = `
          <div class="pill"><span style="width:8px; height:8px; background:#7aa2f7; border-radius:50%"></span>${a.horizon}</div>
          <div style="font-weight:700">${a.title}</div>
          <div class="muted" style="font-size:13px">${a.tip}</div>
          <div class="foot">
            <span class="pill impact">⚡ ${a.impact}</span>
            <span class="pill difficulty">🧩 ${a.difficulty}</span>
          </div>
        `;
        actionsEl.appendChild(card);
      });
    }

    function renderScenarios(dec, risk, opp, unc, domainW){
      // probability mass heuristic
      const baseProb = clamp01(0.6 - (unc-0.4)*0.5);
      const upsideProb = clamp01(0.2 + (opp-0.55)*0.4);
      const downsideProb = clamp01(0.2 + (risk-0.45)*0.5);
      // renormalize
      let sum = baseProb + upsideProb + downsideProb;
      const p = { base:baseProb/sum, up:upsideProb/sum, down:downsideProb/sum };

      // impacts per decision
      function impactBy(decision, type){
        const mult = type==='up'? 1.15 : (type==='down'? 0.82 : 1.0);
        const dimMult = {
          career: type==='up'? 0.07 : (type==='down'? -0.06 : 0.0),
          wealth: type==='up'? 0.08 : (type==='down'? -0.08 : 0.0),
          well:   type==='up'? 0.03 : (type==='down'? -0.04 : 0.0),
          impact: type==='up'? 0.06 : (type==='down'? -0.05 : 0.0),
          res:    type==='up'? 0.04 : (type==='down'? -0.07 : 0.0),
        };
        return { mult, dimMult };
      }

      const scenDefs = [
        { id:'up', label:'Upside (احتمال کم/اثر زیاد)', color:'#aef7d3', prob:p.up },
        { id:'base', label:'Base (محتمل‌ترین)', color:'#7aa2f7', prob:p.base },
        { id:'down', label:'Downside (ریسک دنباله)', color:'#ffb4b4', prob:p.down },
      ];

      scenariosEl.innerHTML = '';
      scenDefs.forEach(s=>{
        const imp = impactBy(dec, s.id);
        const tips = s.id==='up'
          ? 'آزمایش‌های کم‌هزینه با آپساید بزرگ اجرا کن؛ مالکیت فکری/مزیت داده بساز.'
          : s.id==='down'
            ? 'پوشش‌ریسک، کاهش هزینه ثابت، گزینه‌های توقف سریع تعریف کن.'
            : 'بهینه‌سازی جریان کار، شاخص‌های پیشرو را هفتگی رصد کن.';
        const card = document.createElement('div'); card.className='actionCard';
        card.innerHTML = `
          <div class="pill"><span style="width:8px; height:8px; background:${s.color}; border-radius:50%"></span>${s.label} — احتمال: ${(s.prob*100).toFixed(0)}%</div>
          <div class="muted" style="font-size:13px">اثر بر ابعاد: شغل ${Math.round(imp.dimMult.career*100)}، ثروت ${Math.round(imp.dimMult.wealth*100)}، رفاه ${Math.round(imp.dimMult.well*100)}، پایداری ${Math.round(imp.dimMult.impact*100)}، تاب‌آوری ${Math.round(imp.dimMult.res*100)}</div>
          <div style="font-weight:700">اقدام کلیدی: ${tips}</div>
        `;
        scenariosEl.appendChild(card);
      });
    }

    // ---------------------------
    // Recompute pipeline
    // ---------------------------
    function recompute(){ computeScores(); }

    decisionEl.onchange = recompute;
    riskEl.onchange = recompute;
    horizonEl.onchange = recompute;
    profileText.addEventListener('input', ()=>{ clearTimeout(profileText._t); profileText._t=setTimeout(()=>{ /* live hint */ }, 300); });
    thrRiskEl.onchange = recompute;
    thrUncEl.onchange = recompute;

    // ---------------------------
    // Save / Print / Theme
    // ---------------------------
    const saveBtn = document.getElementById('saveBtn');
    const exportBtn = document.getElementById('exportBtn');
    const themeToggle = document.getElementById('themeToggle');

    const savedTheme = localStorage.getItem('afx_theme_v2');
    if(savedTheme==='light'){ document.body.classList.add('light'); themeToggle.checked = true; }

    themeToggle.addEventListener('change', ()=>{
      document.body.classList.toggle('light', themeToggle.checked);
      localStorage.setItem('afx_theme_v2', themeToggle.checked? 'light':'dark');
    });

    saveBtn.addEventListener('click', ()=>{
      const payload = {
        decision: decisionEl.value,
        risk: riskEl.value,
        horizon: horizonEl.value,
        profile: profileText.value,
        trends: Array.from(selectedTrends),
        thrRisk: thrRiskEl.value,
        thrUnc: thrUncEl.value,
        timestamp: Date.now()
      };
      localStorage.setItem('afx_advScenario', JSON.stringify(payload));
      saveBtn.textContent = 'ذخیره شد ✓';
      setTimeout(()=> saveBtn.textContent = 'ذخیره سناریو', 1500);
    });

    exportBtn.addEventListener('click', ()=>{ window.print(); });

    // Restore
    const last = localStorage.getItem('afx_advScenario');
    if(last){
      try{
        const p = JSON.parse(last);
        decisionEl.value = p.decision || decisionEl.value;
        riskEl.value = p.risk || riskEl.value;
        horizonEl.value = p.horizon || horizonEl.value;
        profileText.value = p.profile || '';
        thrRiskEl.value = p.thrRisk || thrRiskEl.value;
        thrUncEl.value = p.thrUnc || thrUncEl.value;
        selectedTrends.clear(); (p.trends || []).forEach(t=>selectedTrends.add(t));
        renderTrendChips();
      }catch(e){}
    }

    recompute();
  </script>
</body>
</html>
